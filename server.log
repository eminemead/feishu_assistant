$ bun server.ts
[info]: [ "client ready" ]
âš ï¸ [Auth] Supabase URL or ANON_KEY not configured. RLS features will be disabled.
âš ï¸ [Auth] SUPABASE_JWT_SECRET not configured. JWT generation will fail.
âš ï¸ [Auth] Supabase credentials not configured. RLS features will be disabled.
[info]: [ "event-dispatch is ready" ]
ğŸ“‹ [Startup] Starting server initialization...
ğŸ“‹ [Startup] Mode: Subscription (WebSocket)
ğŸ“‹ [Startup] Step 1: Initializing WebSocket connection...
[info]: [ "[ws]", "receive events or callbacks through persistent connection only available in self-build & Feishu app, Configured in:\n        Developer Console(å¼€å‘è€…åå°) \n          ->\n        Events and Callbacks(äº‹ä»¶ä¸å›è°ƒ)\n          -> \n        Mode of event/callback subscription(è®¢é˜…æ–¹å¼)\n          -> \n        Receive events/callbacks through persistent connection(ä½¿ç”¨ é•¿è¿æ¥ æ¥æ”¶äº‹ä»¶/å›è°ƒ)" ]
âœ… [Startup] Step 1: WebSocket connection established
ğŸ“‹ [Startup] Ready to receive Feishu events
ğŸ“‹ [Startup] Step 2: Starting HTTP server...
âœ… [Startup] Step 2: HTTP server started on port 3000
âœ¨ [Startup] Server is ready to accept requests
ğŸ“Š [Startup] Health check: curl http://localhost:3000/health
[info]: [ "[ws]", "ws client ready" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "ECONNREFUSED" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[error]: [ "[ws]", "ECONNREFUSED" ]
[info]: [ "ws", "unable to connect to the server after trying 2 times\")" ]
[error]: [ "[ws]", "ECONNREFUSED" ]
[info]: [ "ws", "unable to connect to the server after trying 3 times\")" ]
[error]: [ "[ws]", "ECONNREFUSED" ]
[info]: [ "ws", "unable to connect to the server after trying 4 times\")" ]
[error]: [ "[ws]", "ECONNREFUSED" ]
[info]: [ "ws", "unable to connect to the server after trying 5 times\")" ]
[error]: [ "[ws]", "ECONNREFUSED" ]
[info]: [ "ws", "unable to connect to the server after trying 6 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
ğŸ“¨ [WebSocket] Event received: im.message.receive_v1
ğŸ“¨ [WebSocket] Event data: {
  "schema": "2.0",
  "event_id": "8be3cd1cde3797ac78d9b42c381ab268",
  "token": "",
  "create_time": "1763704291032",
  "event_type": "im.message.receive_v1",
  "tenant_key": "2de1f662118f575d",
  "app_id": "cli_a6af6b76c6f0d013",
  "message": {
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "chat_type": "group",
    "content": "{\"text\":\"@_user_1 new behavior check\"}",
    "create_time": "1763704290710",
    "mentions": [
      {
        "id": {
          "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
          "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
          "user_id": ""
        },
        "key": "@_user_1",
        "name": "Evi",
        "tenant_key": "2de1f662118f575d"
      }
    ],
    "message_id": "om_x100b5ecb90e42ca0c1140ac29f6c58b",
    "message_type": "text",
    "parent_id": "om_x100b5edb3c20e4a0c291114d498450e",
    "root_id": "om_x100b5edb3c20e4a0c291114d498450e",
    "thread_id": "omt_1a7b7fe7f08f1b85",
    "update_time": "1763704290789",
    "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 15_3_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.268 Safari/537.36 Lark/7.56.5 LarkLocale/zh_CN ttnet SDK-Version/7.56.19"
  },
  "sender": {
    "sender_id": {
      "open_id": "ou_db4d1d08c4fcd3f1f4c253eab32ff580",
      "union_id": "on_80d62273b85f0904e27382a59cc1f730",
      "user_id": "xiaofei.yin"
    },
    "sender_type": "user",
    "tenant_key": "2de1f662118f575d"
  }
}
ğŸ¤– [WebSocket] Bot User ID: cli_a6af6b76c6f0d013
ğŸ‘¤ [Auth] Extracted user ID: ou_db4d1d08c4fcd3f1f4c253eab32ff580
ğŸ“© [WebSocket] Message details: chatId=oc_cd4b98905e12ec0cb68adc529440e623, messageId=om_x100b5ecb90e42ca0c1140ac29f6c58b, chatType=group
ğŸ” [WebSocket] Mentions array: [
  {
    "id": {
      "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
      "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
      "user_id": ""
    },
    "key": "@_user_1",
    "name": "Evi",
    "tenant_key": "2de1f662118f575d"
  }
]
ğŸ” [WebSocket] Found 1 mention(s) in group message
âœ… [WebSocket] Bot mention detected via mentions array
ğŸ‘¥ [WebSocket] Processing group mention: "@_user_1 new behavior check..."
Handling app mention
ğŸ“¤ [Card] Creating and sending streaming card to chat_id:oc_cd4b98905e12ec0cb68adc529440e623
âœ… [Card] Created streaming card: cardId=7575161915123780814, elementId=md_29825115
ğŸ“¨ [Card] Sending card message with cardId: 7575161915123780814
ğŸ“¨ [Card] Sending as thread reply to message: om_x100b5ecb90e42ca0c1140ac29f6c58b
âœ… [Card] Card sent successfully: messageId=om_x100b5d3254d758a0c26847ec0c77880, cardId=7575161915123780814
[Thread] Fetching thread history: rootId=om_x100b5edb3c20e4a0c291114d498450e, messageId=om_x100b5ecb90e42ca0c1140ac29f6c58b
âŒ Failed to fetch thread after 1 attempt: Thread fetch timeout after 5000ms
âš ï¸ Proceeding with empty thread context (falling back to current message only)
âš ï¸ [Thread] Thread history empty or fetch failed, using current message only
[Thread] Fallback: Starting fresh with current message only
[Thread] Processing with 1 message(s)
[FeishuMention] Generating response...
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using fallback model: Google Gemini 2.5 Flash (Paid (reliable, no rate limits))
[Manager] Received query: "new behavior check"
[Manager] Starting stream for query: "new behavior check" with primary model
[Manager] Memory context: conversationId=feishu:oc_cd4b98905e12ec0cb68adc529440e623:om_x100b5edb3c20e4a0c291114d498450e, userId=user:ou_db4d1d08c4fcd3f1f4c253eab32ff580, feishuUserId=ou_db4d1d08c4fcd3f1f4c253eab32ff580
[Manager] Stream created, starting to read textStream...
[Manager] fullStream part 1: {
  "type": "start"
}
[Manager] fullStream part 2: {
  "type": "start-step",
  "request": {
    "body": {
      "model": "kwaipilot/kat-coder-pro:free",
      "messages": [
        {
          "role": "system",
          "content": "<system_context>\n
[Manager] fullStream part 3: {
  "type": "text-start",
  "id": "gen-1763729832-0GY3SCKFBQWMhgs8B5Ti"
}
[Manager] fullStream part 4: {
  "type": "text-delta",
  "id": "gen-1763729832-0GY3SCKFBQWMhgs8B5Ti",
  "text": "æˆ‘"
}
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=1, contentLength=1
[Manager] fullStream part 5: {
  "type": "text-delta",
  "id": "gen-1763729832-0GY3SCKFBQWMhgs8B5Ti",
  "text": "çœ‹åˆ°"
}
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=2, contentLength=53
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=3, contentLength=92
[Cache] MISS
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=4, contentLength=95
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=5, contentLength=149
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=6, contentLength=200
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=7, contentLength=256
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=8, contentLength=306
[Manager] fullStream completed with 196 parts
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=9, contentLength=355
[Manager] Finished reading textStream. Total chunks: 181, Final text length: 355
[Manager] Final result received: {
  text: "N/A",
  textLength: 0,
  accumulatedLength: 355,
  usage: {
    input: undefined,
    output: undefined,
    total: undefined,
  },
}
[Manager] Query handled directly (no handoff): "new behavior check"
[Manager] Returning final text (length=355)
[FeishuMention] Response generated (length=355): "æˆ‘çœ‹åˆ°æ‚¨æåˆ°äº†"new behavior check"ï¼Œä½†è¿™ä¸ªæŸ¥è¯¢æ¯”è¾ƒç®€çŸ­ï¼Œæˆ‘éœ€è¦äº†è§£æ›´å¤šä¸Šä¸‹æ–‡æ¥ä¸º..."
[FeishuMention] Finalizing card with suggestions. cardId=7575161915123780814, result length=355
ğŸ¯ [CardSuggestions] Finalizing card with follow-ups: cardId=7575161915123780814, contentLength=355
ğŸ¯ [CardSuggestions] Generating follow-up suggestions...
ğŸ”„ [Followups] Generating 3 follow-up questions for response: "æˆ‘çœ‹åˆ°æ‚¨æåˆ°äº†"new behavior check"ï¼Œä½†è¿™ä¸ªæŸ¥è¯¢æ¯”è¾ƒç®€çŸ­ï¼Œæˆ‘éœ€è¦äº†è§£æ›´å¤šä¸Šä¸‹æ–‡æ¥ä¸º..."
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ”„ [Followups] LLM raw response (first 300 chars): "[
  {"text": "æ‚¨éœ€è¦è¡Œä¸ºæ£€æŸ¥çš„æ¨¡æ¿æˆ–æ ‡å‡†æµç¨‹å—ï¼Ÿ", "type": "question"},
  {"text": "å»ºè®®æ˜ç¡®æ£€æŸ¥ç›®çš„ä»¥é€‰æ‹©åˆé€‚è¯„ä¼°å·¥å…·", "type": "recommendation"},
  {"text": "è¯·è¡¥å……å…·ä½“åœºæ™¯ä»¥ä¾¿è·å–é’ˆå¯¹æ€§æ–¹æ¡ˆ", "type": "action"}
]..."
ğŸ”„ [Followups] Extracted JSON (first 200 chars): "[
  {"text": "æ‚¨éœ€è¦è¡Œä¸ºæ£€æŸ¥çš„æ¨¡æ¿æˆ–æ ‡å‡†æµç¨‹å—ï¼Ÿ", "type": "question"},
  {"text": "å»ºè®®æ˜ç¡®æ£€æŸ¥ç›®çš„ä»¥é€‰æ‹©åˆé€‚è¯„ä¼°å·¥å…·", "type": "recommendation"},
  {"text": "è¯·è¡¥å……å…·ä½“åœºæ™¯ä»¥ä¾¿è·å–é’ˆå¯¹æ€§æ–¹æ¡ˆ", "type": "action"}
]..."
âœ… [Followups] Generated 3 follow-up options with metadata
ğŸ¯ [CardSuggestions] generateFollowupQuestions returned 3 followups
ğŸ¯ [CardSuggestions] Formatting 3 suggestions as markdown...
ğŸ¯ [CardSuggestions] Updating card element with suggestions...
ğŸ”„ [Card] Updating card element: cardId=7575161915123780814, elementId=md_29825115, sequence=10, contentLength=501
âœ… [CardSuggestions] Card updated with 3 text-based suggestions
ğŸ¯ [CardSuggestions] Disabling streaming mode...
âœ… [CardSuggestions] Streaming mode disabled
ğŸ”˜ [CardSuggestions] Sending buttons in separate message (Hypothesis 1)...
ğŸ”˜ [FollowupButtons] Sending 3 buttons in separate message...
ğŸ”˜ [FollowupButtons] Creating card via CardKit...
ğŸ”˜ [FollowupButtons] Card created: 7575161989040377027
ğŸ”˜ [FollowupButtons] Sending as thread reply to rootId=om_x100b5ecb90e42ca0c1140ac29f6c58b...
ğŸ”˜ [FollowupButtons] API response: {
  "code": 0,
  "data": {
    "body": {
      "content": "{\"title\":\"Suggestions\",\"elements\":[[{\"tag\":\"img\",\"image_key\":\"img_v3_02ad_e19fca1f-912a-450e-95de-3c229091b53g\"},{\"tag\":\"text\",\"text\":\"è¯·å‡çº§è‡³æœ€æ–°ç‰ˆæœ¬å®¢æˆ·ç«¯ï¼Œä»¥æŸ¥çœ‹å†…å®¹\"},{\"tag\":\"text\",\"text\":\"\"}]]}"
    },
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "create_time": "1763729842977",
    "deleted": false,
    "message_id": "om_x100b5d3255e168a0c3e693b5c0cf864",
    "msg_type": "interactive",
    "parent_id": "om...
ğŸ”˜ [FollowupButtons] isSuccess=true, code=0, has message_id=true
âœ… [FollowupButtons] Successfully sent buttons message: om_x100b5d3255e168a0c3e693b5c0cf864
âœ… [CardSuggestions] Buttons sent in separate message: om_x100b5d3255e168a0c3e693b5c0cf864
[FeishuMention] Card finalized with suggestions (buttons: om_x100b5d3255e168a0c3e693b5c0cf864)
[error]: [
  [
    {
      message: "The socket connection was closed unexpectedly. For more information, pass `verbose: true` in the second argument to fetch()",
      config: [Object ...],
      request: [Object ...],
      response: [Object ...],
    }
  ]
]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
[info]: [ "[ws]", "reconnect" ]
[error]: [ "[ws]", "timeout of 15000ms exceeded" ]
[info]: [ "ws", "unable to connect to the server after trying 1 times\")" ]
[info]: [ "[ws]", "reconnect" ]
error: script "dev" was terminated by signal SIGTERM (Polite quit request)
