$ bun server.ts
[info]: [ "client ready" ]
ğŸ”§ AI SDK Devtools: Enabled with enhanced features
   - StreamInterceptor support
   - Token usage tracking
   - Session grouping
âœ… [Memory] Connected to Supabase database
[info]: [ "event-dispatch is ready" ]
ğŸ”§ Devtools available at: http://localhost:3000/devtools
ğŸ“‹ [Startup] Starting server initialization...
ğŸ“‹ [Startup] Step 0: Initializing Mastra Memory (3-layer architecture)...
âœ… [Memory] Connected to PostgreSQL storage (Mastra)
ğŸ”§ Devtools API: http://localhost:3000/devtools/api/events
ğŸ”§ Devtools Sessions: http://localhost:3000/devtools/api/sessions
ğŸ”§ Devtools Stats: http://localhost:3000/devtools/api/stats
âœ… [Memory] Mastra memory system initialized
âœ… [Startup] Step 0: Mastra Memory initialized
ğŸ“‹ [Startup] Mode: Subscription (WebSocket)
ğŸ“‹ [Startup] Step 1: Initializing WebSocket connection...
[info]: [ "[ws]", "receive events or callbacks through persistent connection only available in self-build & Feishu app, Configured in:\n        Developer Console(å¼€å‘è€…åå°) \n          ->\n        Events and Callbacks(äº‹ä»¶ä¸å›è°ƒ)\n          -> \n        Mode of event/callback subscription(è®¢é˜…æ–¹å¼)\n          -> \n        Receive events/callbacks through persistent connection(ä½¿ç”¨ é•¿è¿æ¥ æ¥æ”¶äº‹ä»¶/å›è°ƒ)" ]
âœ… [Startup] Step 1: WebSocket connection established
ğŸ“‹ [Startup] Ready to receive Feishu events
ğŸ“‹ [Startup] Step 2: Starting HTTP server...
âœ… [Startup] Step 2: HTTP server started on port 3000
âœ¨ [Startup] Server is ready to accept requests
ğŸ“Š [Startup] Health check: curl http://localhost:3000/health
âŒ [FATAL] Uncaught exception: error: Failed to start server. Is port 3000 in use?
 syscall: "listen",
   errno: 0,
    code: "EADDRINUSE"

      at serve (node:_http_server:554:41)

Stack: Error
    at serve (unknown)
    at [kRealListen] (node:_http_server:554:41)
    at listen (node:_http_server:531:35)
    at serve (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/@hono/node-server/dist/index.mjs:572:10)
    at startServer (/Users/xiaofei.yin/work_repo/feishu_assistant/server.ts:640:3)
    at processTicksAndRejections (unknown:7:39)
[info]: [ "[ws]", "ws client ready" ]
ğŸ“¨ [WebSocket] Event received: im.message.receive_v1
ğŸ“¨ [WebSocket] Event data: {
  "schema": "2.0",
  "event_id": "55cca4353257db8485dc53bc43333819",
  "token": "",
  "create_time": "1764312231267",
  "event_type": "im.message.receive_v1",
  "tenant_key": "2de1f662118f575d",
  "app_id": "cli_a6af6b76c6f0d013",
  "message": {
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "chat_type": "group",
    "content": "{\"text\":\"@_user_1 @_user_2 æ˜¯DPA team çš„ä¸€æšanalytics engineerï¼š è´Ÿè´£æ•´ä¸ªdata stack(i.e. dbt â”dagster â” bi dashboard etc.)\\nä½ æœ‰ä»–çš„OKRå—\"}",
    "create_time": "1764312230929",
    "mentions": [
      {
        "id": {
          "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
          "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
          "user_id": ""
        },
        "key": "@_user_1",
        "name": "Evi",
        "tenant_key": "2de1f662118f575d"
      },
      {
        "id": {
          "open_id": "ou_a6f7929ae2b9aa185c375b14d19b4a22",
          "union_id": "on_fa474c31e356ff2b1b8d76c2b453f886",
          "user_id": "angus.zhan"
        },
        "key": "@_user_2",
        "name": "Angus ZHAN è©¹ä¼Ÿç¿€",
        "tenant_key": "2de1f662118f575d"
      }
    ],
    "message_id": "om_x100b5da004a104b8c38cf30589d78a1",
    "message_type": "text",
    "parent_id": "om_x100b5db4fd4a6c80c4427c8274336f7",
    "root_id": "om_x100b5db4fd4a6c80c4427c8274336f7",
    "thread_id": "omt_1a4d83f1580d1be8",
    "update_time": "1764312231022",
    "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 15_3_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.268 Safari/537.36 Lark/7.56.5 LarkLocale/zh_CN ttnet SDK-Version/7.56.19"
  },
  "sender": {
    "sender_id": {
      "open_id": "ou_db4d1d08c4fcd3f1f4c253eab32ff580",
      "union_id": "on_80d62273b85f0904e27382a59cc1f730",
      "user_id": "xiaofei.yin"
    },
    "sender_type": "user",
    "tenant_key": "2de1f662118f575d"
  }
}
ğŸ¤– [WebSocket] Bot User ID: cli_a6af6b76c6f0d013
ğŸ‘¤ [Auth] Extracted user ID: ou_db4d1d08c4fcd3f1f4c253eab32ff580
ğŸ“© [WebSocket] Message details: chatId=oc_cd4b98905e12ec0cb68adc529440e623, messageId=om_x100b5da004a104b8c38cf30589d78a1, chatType=group
ğŸ” [WebSocket] Mentions array: [
  {
    "id": {
      "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
      "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
      "user_id": ""
    },
    "key": "@_user_1",
    "name": "Evi",
    "tenant_key": "2de1f662118f575d"
  },
  {
    "id": {
      "open_id": "ou_a6f7929ae2b9aa185c375b14d19b4a22",
      "union_id": "on_fa474c31e356ff2b1b8d76c2b453f886",
      "user_id": "angus.zhan"
    },
    "key": "@_user_2",
    "name": "Angus ZHAN è©¹ä¼Ÿç¿€",
    "tenant_key": "2de1f662118f575d"
  }
]
ğŸ“Œ [WebSocket] Extracted mentioned user ID: ou_b996baaafd4fd8f41d219ec7ad2af324 (Evi)
ğŸ” [WebSocket] Found 2 user mention(s) in group (not bot mention)
ğŸ§µ [WebSocket] Processing thread reply: "@_user_1 @_user_2 æ˜¯DPA team çš„ä¸€æšanalytics engineerï¼š..."
Handling new message: oc_cd4b98905e12ec0cb68adc529440e623 om_x100b5db4fd4a6c80c4427c8274336f7
ğŸ“¤ [Card] Creating and sending streaming card to chat_id:oc_cd4b98905e12ec0cb68adc529440e623
âœ… [Card] Created streaming card: cardId=7577664723823594721, elementId=md_12554958
ğŸ“¨ [Card] Sending card message with cardId: 7577664723823594721
ğŸ“¨ [Card] Sending as thread reply to message: om_x100b5db4fd4a6c80c4427c8274336f7
âœ… [Card] Card sent successfully: messageId=om_x100b5da0107720a4c2964d4dabc08b7, cardId=7577664723823594721
