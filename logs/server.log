[info]: [ "client ready" ]
ğŸ”§ AI SDK Devtools: Enabled
âš ï¸ [Auth] Supabase URL or ANON_KEY not configured. RLS features will be disabled.
âš ï¸ [Auth] SUPABASE_JWT_SECRET not configured. JWT generation will fail.
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
âš ï¸ [Auth] Supabase credentials not configured. RLS features will be disabled.
ğŸ¤– [Model] Using primary model: kwaipilot/kat-coder-pro (Free tier (may have rate limits))
ğŸ¤– [Model] Using fallback model: Google Gemini 2.5 Flash (Paid (reliable, no rate limits))
[info]: [ "event-dispatch is ready" ]
ğŸ”§ Devtools available at: http://localhost:3000/devtools
Using Subscription Mode (WebSocket) - no public URL needed
Ensure Subscription Mode is enabled in Feishu admin panel
[info]: [ "[ws]", "receive events or callbacks through persistent connection only available in self-build & Feishu app, Configured in:\n        Developer Console(å¼€å‘è€…åå°) \n          ->\n        Events and Callbacks(äº‹ä»¶ä¸å›è°ƒ)\n          -> \n        Mode of event/callback subscription(è®¢é˜…æ–¹å¼)\n          -> \n        Receive events/callbacks through persistent connection(ä½¿ç”¨ é•¿è¿æ¥ æ¥æ”¶äº‹ä»¶/å›è°ƒ)" ]
Server is running on port 3000
âœ… WebSocket connection established successfully
Subscription Mode is active - ready to receive events
ğŸ”§ Devtools API: http://localhost:3000/devtools/api/events
[info]: [ "[ws]", "ws client ready" ]
ğŸ“¨ [WebSocket] Event received: im.message.receive_v1
ğŸ“¨ [WebSocket] Event data: {
  "schema": "2.0",
  "event_id": "be064364250687c5247f0bb3a7b75e43",
  "token": "",
  "create_time": "1763458832497",
  "event_type": "im.message.receive_v1",
  "tenant_key": "2de1f662118f575d",
  "app_id": "cli_a6af6b76c6f0d013",
  "message": {
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "chat_type": "group",
    "content": "{\"text\":\"@_user_1  think the streaming generation is fixed on card. + some minor tweaks\"}",
    "create_time": "1763458832146",
    "mentions": [
      {
        "id": {
          "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
          "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
          "user_id": ""
        },
        "key": "@_user_1",
        "name": "Evi",
        "tenant_key": "2de1f662118f575d"
      }
    ],
    "message_id": "om_x100b5ef7bfcdb2fc0f26fda44b7cb4e",
    "message_type": "text",
    "update_time": "1763458832146",
    "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 15_3_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.268 Safari/537.36 Lark/7.53.6 LarkLocale/zh_CN ttnet SDK-Version/7.53.10"
  },
  "sender": {
    "sender_id": {
      "open_id": "ou_db4d1d08c4fcd3f1f4c253eab32ff580",
      "union_id": "on_80d62273b85f0904e27382a59cc1f730",
      "user_id": "xiaofei.yin"
    },
    "sender_type": "user",
    "tenant_key": "2de1f662118f575d"
  }
}
ğŸ¤– [WebSocket] Bot User ID: cli_a6af6b76c6f0d013
ğŸ‘¤ [Auth] Extracted user ID: ou_db4d1d08c4fcd3f1f4c253eab32ff580
ğŸ“© [WebSocket] Message details: chatId=oc_cd4b98905e12ec0cb68adc529440e623, messageId=om_x100b5ef7bfcdb2fc0f26fda44b7cb4e, chatType=group
ğŸ” [WebSocket] Mentions array: [
  {
    "id": {
      "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
      "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
      "user_id": ""
    },
    "key": "@_user_1",
    "name": "Evi",
    "tenant_key": "2de1f662118f575d"
  }
]
ğŸ” [WebSocket] Found 1 mention(s) in group message
âœ… [WebSocket] Bot mention detected via mentions array
ğŸ‘¥ [WebSocket] Processing group mention: "@_user_1  think the streaming generation is fixed ..."
Handling app mention
[Devtools] agent_call: {
  agent: "FeishuMention",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
ğŸ“¤ [Card] Creating and sending streaming card to chat_id:oc_cd4b98905e12ec0cb68adc529440e623
âœ… [Card] Created streaming card: cardId=7573998011019591681, elementId=md_58832609
ğŸ“¨ [Card] Sending card message with cardId: 7573998011019591681
ğŸ“¨ [Card] Sending as thread reply to message: om_x100b5ef7bfcdb2fc0f26fda44b7cb4e
âœ… [Card] Card sent successfully: messageId=om_x100b5ef7bfde58500f236862275332c, cardId=7573998011019591681
[Thread] New mention (messageId === rootId), starting fresh conversation
[Thread] Processing with 1 message(s)
[Manager] Received query: "@_user_1  think the streaming generation is fixed on card. + some minor tweaks"
[Devtools] agent_call: {
  agent: "Manager",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
[Manager] Starting stream for query: "@_user_1  think the streaming generation is fixed on card. + some minor tweaks" with primary model
[Manager] Memory context: conversationId=feishu:oc_cd4b98905e12ec0cb68adc529440e623:om_x100b5ef7bfcdb2fc0f26fda44b7cb4e, userId=user:ou_db4d1d08c4fcd3f1f4c253eab32ff580, feishuUserId=ou_db4d1d08c4fcd3f1f4c253eab32ff580
[Manager] Stream created, starting to read textStream...
57 |   constructor({
58 |     name: name14,
59 |     message,
60 |     cause
61 |   }) {
62 |     super(message);
         ^
AI_RetryError: Failed after 3 attempts. Last error: Provider returned error
      cause: undefined,
     reason: "maxRetriesExceeded",
     errors: [
  43340 |   constructor({
43341 |     name: name143,
43342 |     message,
43343 |     cause
43344 |   }) {
43345 |     super(message);
            ^
AI_APICallError: Provider returned error
      cause: undefined,
        url: "https://openrouter.ai/api/v1/chat/completions",
 requestBodyValues: [Object ...],
 statusCode: 429,
 responseHeaders: [Object ...],
 responseBody: "{\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"kwaipilot/kat-coder-pro:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Novita\"}},\"user_id\":\"user_2uL47zO0mbwAjPFsqpl6EivKGbW\"}",
 isRetryable: true,
       data: [Object ...],
 vercel.ai.error: true,
 vercel.ai.error.AI_APICallError: true,

      at new _AISDKError22 (/Users/xiaofei.yin/work_repo/feishu_assistant/dist/server.js:43345:5)
, 43340 |   constructor({
43341 |     name: name143,
43342 |     message,
43343 |     cause
43344 |   }) {
43345 |     super(message);
            ^
AI_APICallError: Provider returned error
      cause: undefined,
        url: "https://openrouter.ai/api/v1/chat/completions",
 requestBodyValues: [Object ...],
 statusCode: 429,
 responseHeaders: [Object ...],
 responseBody: "{\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"kwaipilot/kat-coder-pro:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Novita\"}},\"user_id\":\"user_2uL47zO0mbwAjPFsqpl6EivKGbW\"}",
 isRetryable: true,
       data: [Object ...],
 vercel.ai.error: true,
 vercel.ai.error.AI_APICallError: true,

      at new _AISDKError22 (/Users/xiaofei.yin/work_repo/feishu_assistant/dist/server.js:43345:5)
, 43340 |   constructor({
43341 |     name: name143,
43342 |     message,
43343 |     cause
43344 |   }) {
43345 |     super(message);
            ^
AI_APICallError: Provider returned error
      cause: undefined,
        url: "https://openrouter.ai/api/v1/chat/completions",
 requestBodyValues: [Object ...],
 statusCode: 429,
 responseHeaders: [Object ...],
 responseBody: "{\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"kwaipilot/kat-coder-pro:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Novita\"}},\"user_id\":\"user_2uL47zO0mbwAjPFsqpl6EivKGbW\"}",
 isRetryable: true,
       data: [Object ...],
 vercel.ai.error: true,
 vercel.ai.error.AI_APICallError: true,

      at new _AISDKError22 (/Users/xiaofei.yin/work_repo/feishu_assistant/dist/server.js:43345:5)

],
 vercel.ai.error: true,
 vercel.ai.error.AI_RetryError: true,

      at new _AISDKError (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/@ai-sdk/provider/dist/index.js:62:5)

43340 |   constructor({
43341 |     name: name143,
43342 |     message,
43343 |     cause
43344 |   }) {
43345 |     super(message);
            ^
AI_APICallError: Provider returned error
      cause: undefined,
        url: "https://openrouter.ai/api/v1/chat/completions",
 requestBodyValues: {
  model: "kwaipilot/kat-coder-pro:free",
  models: undefined,
  logit_bias: undefined,
  logprobs: undefined,
  top_logprobs: undefined,
  user: undefined,
  parallel_tool_calls: undefined,
  max_tokens: undefined,
  temperature: undefined,
  top_p: undefined,
  frequency_penalty: undefined,
  presence_penalty: undefined,
  seed: undefined,
  stop: undefined,
  response_format: undefined,
  top_k: undefined,
  messages: [
    [Object ...], [Object ...]
  ],
  include_reasoning: undefined,
  reasoning: undefined,
  usage: undefined,
  plugins: undefined,
  web_search_options: undefined,
  provider: undefined,
  tools: [
    [Object ...], [Object ...], [Object ...]
  ],
  tool_choice: "auto",
  stream: true,
  stream_options: undefined,
},
 statusCode: 429,
 responseHeaders: {
  "access-control-allow-origin": "*",
  "cf-ray": "9a068201d8579b41-HKG",
  connection: "keep-alive",
  "content-type": "application/json",
  date: "Tue, 18 Nov 2025 09:40:42 GMT",
  "permissions-policy": "payment=(self \"https://checkout.stripe.com\" \"https://connect-js.stripe.com\" \"https://js.stripe.com\" \"https://*.js.stripe.com\" \"https://hooks.stripe.com\")",
  "referrer-policy": "no-referrer, strict-origin-when-cross-origin",
  server: "cloudflare",
  "transfer-encoding": "chunked",
  vary: "Accept-Encoding",
  "x-content-type-options": "nosniff",
},
 responseBody: "{\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"kwaipilot/kat-coder-pro:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Novita\"}},\"user_id\":\"user_2uL47zO0mbwAjPFsqpl6EivKGbW\"}",
 isRetryable: true,
       data: {
  error: [Object ...],
  user_id: "user_2uL47zO0mbwAjPFsqpl6EivKGbW",
},
 vercel.ai.error: true,
 vercel.ai.error.AI_APICallError: true,

      at new _AISDKError22 (/Users/xiaofei.yin/work_repo/feishu_assistant/dist/server.js:43345:5)

[Manager] Finished reading textStream. Total chunks: 0, Final text length: 0
[Manager] Final result received: {
  text: "N/A",
  textLength: 0,
  accumulatedLength: 0,
}
[Manager] Query handled directly (no handoff): "@_user_1  think the streaming generation is fixed on card. + some minor tweaks"
[Devtools] response: {
  agent: "Manager",
  tool: undefined,
  duration: 9365,
  error: undefined,
}
[Manager] Returning final text (length=0)
âŒ [WARN] Unhandled rejection at: Promise { <rejected> } reason: 57 |   constructor({
58 |     name: name14,
59 |     message,
60 |     cause
61 |   }) {
62 |     super(message);
         ^
AI_NoOutputGeneratedError: No output generated. Check the stream for errors.
      cause: undefined,
 vercel.ai.error: true,
 vercel.ai.error.AI_NoOutputGeneratedError: true,

      at new _AISDKError (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/@ai-sdk/provider/dist/index.js:62:5)
      at new NoOutputGeneratedError (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/ai/dist/index.js:347:5)
      at flush (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/ai/dist/index.js:4839:27)
      at flush (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/ai/dist/index.js:4836:19)
      at finalize (5:73)

âŒ [WARN] Unhandled rejection at: Promise { <rejected> } reason: 57 |   constructor({
58 |     name: name14,
59 |     message,
60 |     cause
61 |   }) {
62 |     super(message);
         ^
AI_NoOutputGeneratedError: No output generated. Check the stream for errors.
      cause: undefined,
 vercel.ai.error: true,
 vercel.ai.error.AI_NoOutputGeneratedError: true,

      at new _AISDKError (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/@ai-sdk/provider/dist/index.js:62:5)
      at new NoOutputGeneratedError (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/ai/dist/index.js:347:5)
      at flush (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/ai/dist/index.js:4839:27)
      at flush (/Users/xiaofei.yin/work_repo/feishu_assistant/node_modules/ai/dist/index.js:4836:19)
      at finalize (5:73)

[Devtools] response: {
  agent: "FeishuMention",
  tool: undefined,
  duration: 10488,
  error: undefined,
}
âš ï¸ [WebSocket] Duplicate event ignored: be064364250687c5247f0bb3a7b75e43
ğŸ“¨ [WebSocket] Event received: im.message.receive_v1
ğŸ“¨ [WebSocket] Event data: {
  "schema": "2.0",
  "event_id": "3859dd8924aa8deb9f8f3b967905e350",
  "token": "",
  "create_time": "1763455154876",
  "event_type": "im.message.receive_v1",
  "tenant_key": "2de1f662118f575d",
  "app_id": "cli_a6af6b76c6f0d013",
  "message": {
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "chat_type": "group",
    "content": "{\"text\":\"@_user_1 good to know.\\n\\næœ¬æœˆOKRè®¾å®šæƒ…å†µå¦‚ä½•ï¼Ÿ\"}",
    "create_time": "1763455154553",
    "mentions": [
      {
        "id": {
          "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
          "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
          "user_id": ""
        },
        "key": "@_user_1",
        "name": "Evi",
        "tenant_key": "2de1f662118f575d"
      }
    ],
    "message_id": "om_x100b5ef745eb24bcc4b8a4db40e799e",
    "message_type": "text",
    "parent_id": "om_x100b5ef6a35358200f2aedfb8ed10b5",
    "root_id": "om_x100b5ef6a35358200f2aedfb8ed10b5",
    "thread_id": "omt_1a79a610cb47175e",
    "update_time": "1763455154553",
    "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 15_3_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.268 Safari/537.36 Lark/7.53.6 LarkLocale/zh_CN ttnet SDK-Version/7.53.10"
  },
  "sender": {
    "sender_id": {
      "open_id": "ou_db4d1d08c4fcd3f1f4c253eab32ff580",
      "union_id": "on_80d62273b85f0904e27382a59cc1f730",
      "user_id": "xiaofei.yin"
    },
    "sender_type": "user",
    "tenant_key": "2de1f662118f575d"
  }
}
ğŸ¤– [WebSocket] Bot User ID: cli_a6af6b76c6f0d013
ğŸ‘¤ [Auth] Extracted user ID: ou_db4d1d08c4fcd3f1f4c253eab32ff580
ğŸ“© [WebSocket] Message details: chatId=oc_cd4b98905e12ec0cb68adc529440e623, messageId=om_x100b5ef745eb24bcc4b8a4db40e799e, chatType=group
ğŸ” [WebSocket] Mentions array: [
  {
    "id": {
      "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
      "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
      "user_id": ""
    },
    "key": "@_user_1",
    "name": "Evi",
    "tenant_key": "2de1f662118f575d"
  }
]
ğŸ” [WebSocket] Found 1 mention(s) in group message
âœ… [WebSocket] Bot mention detected via mentions array
ğŸ‘¥ [WebSocket] Processing group mention: "@_user_1 good to know.

æœ¬æœˆOKRè®¾å®šæƒ…å†µå¦‚ä½•ï¼Ÿ..."
Handling app mention
[Devtools] agent_call: {
  agent: "FeishuMention",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
ğŸ“¤ [Card] Creating and sending streaming card to chat_id:oc_cd4b98905e12ec0cb68adc529440e623
âœ… [Card] Created streaming card: cardId=7573999075652157441, elementId=md_59079927
ğŸ“¨ [Card] Sending card message with cardId: 7573999075652157441
ğŸ“¨ [Card] Sending as thread reply to message: om_x100b5ef745eb24bcc4b8a4db40e799e
âœ… [Card] Card sent successfully: messageId=om_x100b5ef04e45a49c0f1f70bb188aa0f, cardId=7573999075652157441
[Thread] Fetching thread history: rootId=om_x100b5ef6a35358200f2aedfb8ed10b5, messageId=om_x100b5ef745eb24bcc4b8a4db40e799e
âŒ Failed to fetch thread after 1 attempt: Thread fetch timeout after 5000ms
âš ï¸ Proceeding with empty thread context (falling back to current message only)
âš ï¸ [Thread] Thread history empty or fetch failed, using current message only
[Thread] Fallback: Starting fresh with current message only
[Thread] Processing with 1 message(s)
[Manager] Received query: "@_user_1 good to know.

æœ¬æœˆOKRè®¾å®šæƒ…å†µå¦‚ä½•ï¼Ÿ"
[Devtools] agent_call: {
  agent: "Manager",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
[Manager] Starting stream for query: "@_user_1 good to know.

æœ¬æœˆOKRè®¾å®šæƒ…å†µå¦‚ä½•ï¼Ÿ" with primary model
[Manager] Memory context: conversationId=feishu:oc_cd4b98905e12ec0cb68adc529440e623:om_x100b5ef6a35358200f2aedfb8ed10b5, userId=user:ou_db4d1d08c4fcd3f1f4c253eab32ff580, feishuUserId=ou_db4d1d08c4fcd3f1f4c253eab32ff580
[Manager] Stream created, starting to read textStream...
ğŸ”„ [Card] Updating card element: cardId=7573999075652157441, elementId=md_59079927, sequence=1, contentLength=1
ğŸ”„ [Card] Updating card element: cardId=7573999075652157441, elementId=md_59079927, sequence=2, contentLength=12
ğŸ”„ [Card] Updating card element: cardId=7573999075652157441, elementId=md_59079927, sequence=3, contentLength=22
ğŸ”„ [Card] Updating card element: cardId=7573999075652157441, elementId=md_59079927, sequence=4, contentLength=33
ğŸ”„ [Card] Updating card element: cardId=7573999075652157441, elementId=md_59079927, sequence=5, contentLength=43
ğŸ”„ [Card] Updating card element: cardId=7573999075652157441, elementId=md_59079927, sequence=6, contentLength=44
[Manager] Finished reading textStream. Total chunks: 23, Final text length: 44
[Manager] Final result received: {
  text: "N/A",
  textLength: 0,
  accumulatedLength: 44,
}
[Manager] Query handled directly (no handoff): "@_user_1 good to know.

æœ¬æœˆOKRè®¾å®šæƒ…å†µå¦‚ä½•ï¼Ÿ"
[Devtools] response: {
  agent: "Manager",
  tool: undefined,
  duration: 10089,
  error: undefined,
}
[Manager] Returning final text (length=44)
[Devtools] response: {
  agent: "FeishuMention",
  tool: undefined,
  duration: 16132,
  error: undefined,
}
ğŸ“¨ [WebSocket] Event received: im.message.receive_v1
ğŸ“¨ [WebSocket] Event data: {
  "schema": "2.0",
  "event_id": "71d1a68e1a51872c6085d3296e029bab",
  "token": "",
  "create_time": "1763459165420",
  "event_type": "im.message.receive_v1",
  "tenant_key": "2de1f662118f575d",
  "app_id": "cli_a6af6b76c6f0d013",
  "message": {
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "chat_type": "group",
    "content": "{\"text\":\"@_user_1 having almost PTSD now.\"}",
    "create_time": "1763459165110",
    "mentions": [
      {
        "id": {
          "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
          "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
          "user_id": ""
        },
        "key": "@_user_1",
        "name": "Evi",
        "tenant_key": "2de1f662118f575d"
      }
    ],
    "message_id": "om_x100b5ef04b03c8ec0ecca9bc62f15aa",
    "message_type": "text",
    "update_time": "1763459165110"
  },
  "sender": {
    "sender_id": {
      "open_id": "ou_db4d1d08c4fcd3f1f4c253eab32ff580",
      "union_id": "on_80d62273b85f0904e27382a59cc1f730",
      "user_id": "xiaofei.yin"
    },
    "sender_type": "user",
    "tenant_key": "2de1f662118f575d"
  }
}
ğŸ¤– [WebSocket] Bot User ID: cli_a6af6b76c6f0d013
ğŸ‘¤ [Auth] Extracted user ID: ou_db4d1d08c4fcd3f1f4c253eab32ff580
ğŸ“© [WebSocket] Message details: chatId=oc_cd4b98905e12ec0cb68adc529440e623, messageId=om_x100b5ef04b03c8ec0ecca9bc62f15aa, chatType=group
ğŸ” [WebSocket] Mentions array: [
  {
    "id": {
      "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
      "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
      "user_id": ""
    },
    "key": "@_user_1",
    "name": "Evi",
    "tenant_key": "2de1f662118f575d"
  }
]
ğŸ” [WebSocket] Found 1 mention(s) in group message
âœ… [WebSocket] Bot mention detected via mentions array
ğŸ‘¥ [WebSocket] Processing group mention: "@_user_1 having almost PTSD now...."
Handling app mention
[Devtools] agent_call: {
  agent: "FeishuMention",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
ğŸ“¤ [Card] Creating and sending streaming card to chat_id:oc_cd4b98905e12ec0cb68adc529440e623
âœ… [Card] Created streaming card: cardId=7573999442791088156, elementId=md_59165523
ğŸ“¨ [Card] Sending card message with cardId: 7573999442791088156
ğŸ“¨ [Card] Sending as thread reply to message: om_x100b5ef04b03c8ec0ecca9bc62f15aa
âœ… [Card] Card sent successfully: messageId=om_x100b5ef04b2d08a0c30a0b5c70fccbd, cardId=7573999442791088156
[Thread] New mention (messageId === rootId), starting fresh conversation
[Thread] Processing with 1 message(s)
[Manager] Received query: "@_user_1 having almost PTSD now."
[Devtools] agent_call: {
  agent: "Manager",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
[Manager] Starting stream for query: "@_user_1 having almost PTSD now." with primary model
[Manager] Memory context: conversationId=feishu:oc_cd4b98905e12ec0cb68adc529440e623:om_x100b5ef04b03c8ec0ecca9bc62f15aa, userId=user:ou_db4d1d08c4fcd3f1f4c253eab32ff580, feishuUserId=ou_db4d1d08c4fcd3f1f4c253eab32ff580
[Manager] Stream created, starting to read textStream...
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=1, contentLength=1
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=2, contentLength=16
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=3, contentLength=28
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=4, contentLength=39
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=5, contentLength=49
[error]: [
  [
    {
      message: "The socket connection was closed unexpectedly. For more information, pass `verbose: true` in the second argument to fetch()",
      config: [Object ...],
      request: [Object ...],
      response: [Object ...],
    }
  ]
]
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=6, contentLength=61
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=7, contentLength=72
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=8, contentLength=85
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=9, contentLength=99
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=10, contentLength=112
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=11, contentLength=125
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=12, contentLength=138
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=13, contentLength=152
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=14, contentLength=163
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=15, contentLength=176
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=16, contentLength=189
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=17, contentLength=199
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=18, contentLength=212
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=19, contentLength=229
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=20, contentLength=239
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=21, contentLength=254
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=22, contentLength=264
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=23, contentLength=279
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=24, contentLength=297
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=25, contentLength=314
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=26, contentLength=326
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=27, contentLength=343
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=28, contentLength=356
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=29, contentLength=370
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=30, contentLength=383
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=31, contentLength=398
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=32, contentLength=415
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=33, contentLength=430
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=34, contentLength=441
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=35, contentLength=455
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=36, contentLength=475
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=37, contentLength=491
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=38, contentLength=501
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=39, contentLength=515
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=40, contentLength=527
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=41, contentLength=542
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=42, contentLength=553
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=43, contentLength=568
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=44, contentLength=579
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=45, contentLength=589
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=46, contentLength=599
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=47, contentLength=613
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=48, contentLength=629
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=49, contentLength=646
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=50, contentLength=657
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=51, contentLength=668
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=52, contentLength=678
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=53, contentLength=689
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=54, contentLength=705
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=55, contentLength=717
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=56, contentLength=731
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=57, contentLength=742
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=58, contentLength=758
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=59, contentLength=775
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=60, contentLength=786
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=61, contentLength=798
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=62, contentLength=808
ğŸ”„ [Card] Updating card element: cardId=7573999442791088156, elementId=md_59165523, sequence=63, contentLength=809
[Manager] Finished reading textStream. Total chunks: 155, Final text length: 809
[Manager] Final result received: {
  text: "N/A",
  textLength: 0,
  accumulatedLength: 809,
}
[Manager] Query handled directly (no handoff): "@_user_1 having almost PTSD now."
[Devtools] response: {
  agent: "Manager",
  tool: undefined,
  duration: 16822,
  error: undefined,
}
[Manager] Returning final text (length=809)
[Devtools] response: {
  agent: "FeishuMention",
  tool: undefined,
  duration: 17789,
  error: undefined,
}
âš ï¸ [WebSocket] Duplicate event ignored: 71d1a68e1a51872c6085d3296e029bab
ğŸ“¨ [WebSocket] Event received: im.message.receive_v1
ğŸ“¨ [WebSocket] Event data: {
  "schema": "2.0",
  "event_id": "fc57838eade88c75891b947b7c54ae55",
  "token": "",
  "create_time": "1763459270555",
  "event_type": "im.message.receive_v1",
  "tenant_key": "2de1f662118f575d",
  "app_id": "cli_a6af6b76c6f0d013",
  "message": {
    "chat_id": "oc_cd4b98905e12ec0cb68adc529440e623",
    "chat_type": "group",
    "content": "{\"text\":\"@_user_1 how to continue this convo?\"}",
    "create_time": "1763459270267",
    "mentions": [
      {
        "id": {
          "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
          "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
          "user_id": ""
        },
        "key": "@_user_1",
        "name": "Evi",
        "tenant_key": "2de1f662118f575d"
      }
    ],
    "message_id": "om_x100b5ef042af24cc0eca8924af2d42a",
    "message_type": "text",
    "parent_id": "om_x100b5ef04b03c8ec0ecca9bc62f15aa",
    "root_id": "om_x100b5ef04b03c8ec0ecca9bc62f15aa",
    "thread_id": "omt_1a79c895c24bd740",
    "update_time": "1763459270267"
  },
  "sender": {
    "sender_id": {
      "open_id": "ou_db4d1d08c4fcd3f1f4c253eab32ff580",
      "union_id": "on_80d62273b85f0904e27382a59cc1f730",
      "user_id": "xiaofei.yin"
    },
    "sender_type": "user",
    "tenant_key": "2de1f662118f575d"
  }
}
ğŸ¤– [WebSocket] Bot User ID: cli_a6af6b76c6f0d013
ğŸ‘¤ [Auth] Extracted user ID: ou_db4d1d08c4fcd3f1f4c253eab32ff580
ğŸ“© [WebSocket] Message details: chatId=oc_cd4b98905e12ec0cb68adc529440e623, messageId=om_x100b5ef042af24cc0eca8924af2d42a, chatType=group
ğŸ” [WebSocket] Mentions array: [
  {
    "id": {
      "open_id": "ou_b996baaafd4fd8f41d219ec7ad2af324",
      "union_id": "on_cb96bf8f32689f8c0b7415ad3a6b6d4e",
      "user_id": ""
    },
    "key": "@_user_1",
    "name": "Evi",
    "tenant_key": "2de1f662118f575d"
  }
]
ğŸ” [WebSocket] Found 1 mention(s) in group message
âœ… [WebSocket] Bot mention detected via mentions array
ğŸ‘¥ [WebSocket] Processing group mention: "@_user_1 how to continue this convo?..."
Handling app mention
[Devtools] agent_call: {
  agent: "FeishuMention",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
ğŸ“¤ [Card] Creating and sending streaming card to chat_id:oc_cd4b98905e12ec0cb68adc529440e623
âœ… [Card] Created streaming card: cardId=7573999893991079937, elementId=md_59270673
ğŸ“¨ [Card] Sending card message with cardId: 7573999893991079937
ğŸ“¨ [Card] Sending as thread reply to message: om_x100b5ef042af24cc0eca8924af2d42a
âœ… [Card] Card sent successfully: messageId=om_x100b5ef042bfa4200ec1233d1309d3e, cardId=7573999893991079937
[Thread] Fetching thread history: rootId=om_x100b5ef04b03c8ec0ecca9bc62f15aa, messageId=om_x100b5ef042af24cc0eca8924af2d42a
âŒ Failed to fetch thread after 1 attempt: Thread fetch timeout after 5000ms
âš ï¸ Proceeding with empty thread context (falling back to current message only)
âš ï¸ [Thread] Thread history empty or fetch failed, using current message only
[Thread] Fallback: Starting fresh with current message only
[Thread] Processing with 1 message(s)
[Manager] Received query: "@_user_1 how to continue this convo?"
[Devtools] agent_call: {
  agent: "Manager",
  tool: undefined,
  duration: undefined,
  error: undefined,
}
[Manager] Starting stream for query: "@_user_1 how to continue this convo?" with primary model
[Manager] Memory context: conversationId=feishu:oc_cd4b98905e12ec0cb68adc529440e623:om_x100b5ef04b03c8ec0ecca9bc62f15aa, userId=user:ou_db4d1d08c4fcd3f1f4c253eab32ff580, feishuUserId=ou_db4d1d08c4fcd3f1f4c253eab32ff580
[Manager] Stream created, starting to read textStream...
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=1, contentLength=1
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=2, contentLength=12
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=3, contentLength=22
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=4, contentLength=38
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=5, contentLength=56
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=6, contentLength=67
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=7, contentLength=77
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=8, contentLength=94
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=9, contentLength=105
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=10, contentLength=116
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=11, contentLength=127
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=12, contentLength=140
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=13, contentLength=152
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=14, contentLength=166
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=15, contentLength=176
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=16, contentLength=190
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=17, contentLength=203
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=18, contentLength=214
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=19, contentLength=224
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=20, contentLength=243
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=21, contentLength=254
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=22, contentLength=264
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=23, contentLength=274
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=24, contentLength=290
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=25, contentLength=300
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=26, contentLength=317
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=27, contentLength=334
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=28, contentLength=345
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=29, contentLength=358
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=30, contentLength=370
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=31, contentLength=388
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=32, contentLength=407
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=33, contentLength=421
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=34, contentLength=437
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=35, contentLength=455
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=36, contentLength=466
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=37, contentLength=476
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=38, contentLength=488
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=39, contentLength=498
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=40, contentLength=513
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=41, contentLength=524
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=42, contentLength=536
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=43, contentLength=548
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=44, contentLength=563
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=45, contentLength=573
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=46, contentLength=584
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=47, contentLength=595
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=48, contentLength=607
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=49, contentLength=618
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=50, contentLength=630
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=51, contentLength=640
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=52, contentLength=652
ğŸ”„ [Card] Updating card element: cardId=7573999893991079937, elementId=md_59270673, sequence=53, contentLength=661
[Manager] Finished reading textStream. Total chunks: 145, Final text length: 661
[Manager] Final result received: {
  text: "N/A",
  textLength: 0,
  accumulatedLength: 661,
}
[Manager] Query handled directly (no handoff): "@_user_1 how to continue this convo?"
[Devtools] response: {
  agent: "Manager",
  tool: undefined,
  duration: 11437,
  error: undefined,
}
[Manager] Returning final text (length=661)
[Devtools] response: {
  agent: "FeishuMention",
  tool: undefined,
  duration: 17296,
  error: undefined,
}
âš ï¸ [WebSocket] Duplicate event ignored: fc57838eade88c75891b947b7c54ae55
[error]: [
  [
    {
      message: "The socket connection was closed unexpectedly. For more information, pass `verbose: true` in the second argument to fetch()",
      config: [Object ...],
      request: [Object ...],
      response: [Object ...],
    }
  ]
]
[warn]: [ "no im.message.reaction.created_v1 handle" ]
[warn]: [ "no im.message.reaction.created_v1 handle" ]
