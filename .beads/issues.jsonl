{"id":"feishu_assistant-0c7","content_hash":"aa972bc8d167e81e2116562abd6d94bb0d2c24a8f5baaea64acf27c3600bd744","title":"Phase 4: Memory \u0026 Devtools Integration - Complete","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-11-27T15:13:58.878862+08:00","updated_at":"2025-11-27T15:13:58.878862+08:00","source_repo":"."}
{"id":"feishu_assistant-0dx","content_hash":"b7fc33497f44393d34c9c348f3f852d6c0fbfbc03653a390b4591fb0233438f1","title":"Migrate P\u0026L Agent to Mastra framework","description":"# Migrate P\u0026L Agent to Mastra\n\n## Context\nP\u0026L Agent handles profit and loss analysis queries.\n\n## What Needs to Be Done\n1. Replace pnl-agent.ts with Mastra version\n2. Update model array\n3. Keep tool definitions\n4. Update memory integration\n5. Delete pnl-agent-mastra.ts\n\n## Files Involved\n- lib/agents/pnl-agent.ts\n- lib/agents/pnl-agent-mastra.ts (delete)\n- test/agents/*.test.ts (update)\n\n## Success Criteria\n- ‚úÖ Agent works\n- ‚úÖ Tests passing\n- ‚úÖ No regressions\n\n## Blocked By\n- Migrate Manager Agent\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:44.65293+08:00","updated_at":"2025-12-02T12:52:44.65293+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-0dx","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.654016+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-0xl","content_hash":"0bad7268ee1b23199880b6dd62a9291f04e5b80c126ecfa011fbc9c9dada9d3a","title":"Implement getDocMetadata() core function with error handling","description":"\nWrite the main function with:\n- Raw HTTP request setup\n- Response parsing and validation\n- Proper error handling (404, 403, transient)\n- Logging at all levels\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:55.193804+08:00","updated_at":"2025-12-02T11:46:55.193804+08:00","source_repo":"."}
{"id":"feishu_assistant-18l","content_hash":"d6e513162c03bc228a179286fdd1bab8a62e9754248bf53337e595cfe32337ef","title":"Run dual-read tests to verify memory consistency","description":"# Dual-Read Tests for Memory Consistency\n\n## Context\nDuring migration, agents may read from both old (ai-sdk-tools) and new (Mastra) memory. We need to verify they return same results.\n\n## What Needs to Be Done\n1. Create test script: test/integration/memory-dual-read.test.ts\n   - Insert conversation in both backends\n   - Read from both\n   - Compare results\n   - Verify no differences\n\n2. Test various scenarios:\n   - Single message conversation\n   - Multi-turn conversation\n   - Conversation with metadata\n   - Conversation with large messages\n\n3. Measure performance:\n   - Latency of dual-read\n   - Memory overhead\n   - Decide if optimization needed\n\n4. Document findings\n5. Remove dual-read code after cutover\n\n## Files Involved\n- test/integration/memory-dual-read.test.ts (new)\n- lib/agents/memory-integration.ts (dual-read logic)\n\n## Success Criteria\n- ‚úÖ Dual reads return identical results\n- ‚úÖ Performance acceptable\n- ‚úÖ Tests passing\n- ‚úÖ Ready for cutover\n\n## Blocked By\n- Transition conversation history to Mastra memory\n- Migrate all agents to Mastra\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:45.229801+08:00","updated_at":"2025-12-02T12:52:45.229801+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-18l","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.230524+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-1mv","content_hash":"16cc4f97f6f60b55dc1536aa65eff0e1733a04ea55b78bd73999e470a8f31830","title":"Migrate Feishu Assistant from ai-sdk-tools to Mastra Framework","description":"# Mastra Framework Migration\n\n## Why This Epic Exists\n\nThe Feishu Assistant currently uses @ai-sdk-tools/agents which is in maintenance mode. We're migrating to Mastra framework to:\n\n1. **Simplify agent architecture** - Native model fallback arrays eliminate dual-agent pattern\n2. **Improve observability** - Mastra AI Tracing designed specifically for LLM operations (vs custom devtools)\n3. **Modernize tech stack** - Mastra is actively developed with 18.5k GitHub stars, strong community\n4. **Reduce code complexity** - Remove ~500 lines of handoff routing + dual agent management\n5. **Unify memory system** - Mastra memory + PostgreSQL replaces ai-sdk-tools + Supabase+Drizzle\n\n## Long-Term Goals This Serves\n\n1. **Production readiness** - Move to actively maintained framework with better observability\n2. **Scalability** - PostgreSQL memory backend scales better than Drizzle+Supabase for concurrent users\n3. **Team knowledge** - Mastra becoming de facto standard in AI agent community (LLM layer unification)\n4. **Developer velocity** - Simpler codebase = faster feature development + fewer bugs\n5. **Cost optimization** - Consolidated observability (Langfuse) vs custom devtools + Feishu logging\n\n## Technical Architecture\n\n### Current State (ai-sdk-tools)\n- Dual agents (primary + fallback) for model fallback\n- Custom devtools tracking (~300 lines of tracking code)\n- ai-sdk-tools memory with Supabase backend\n- Manual agent handoff routing with regex patterns\n- Cache layer with TTL support\n\n### Target State (Mastra)\n- Single agent with model array fallback (auto-managed by Mastra)\n- Native AI Tracing with multiple exporter options (Langfuse, Braintrust, OTEL)\n- Mastra memory with PostgreSQL backend\n- Native Mastra workflow/agent switching (no custom routing needed)\n- Mastra built-in caching\n\n### Compatibility Notes\n- Tools already use universal tool() signature from 'ai' package - no changes needed\n- Memory migration is bidirectional (can coexist initially)\n- Observability improvements are backwards compatible\n\n## Implementation Strategy\n\n### Phase 1: Setup \u0026 Infrastructure (Days 1-2)\n- Add Mastra observability config (PinoLogger, AI Tracing)\n- Verify PostgreSQL schema for Mastra memory\n- Test connection pooling and transaction handling\n\n### Phase 2: Agent Migration (Days 3-5)\n- Migrate Manager Agent (highest impact, orchestrator)\n- Migrate specialist agents (OKR, Alignment, P\u0026L, DPA-PM)\n- No changes needed for tools (already compatible)\n\n### Phase 3: Memory \u0026 State (Day 6)\n- Transition conversation history to Mastra memory\n- Verify RLS still works correctly\n- Run dual-read tests (both memory systems)\n\n### Phase 4: Observability (Day 7)\n- Configure Langfuse exporter\n- Set up real-time tracing (dev) + batch mode (prod)\n- Retire custom devtools-integration.ts\n\n### Phase 5: Testing \u0026 Validation (Days 8-10)\n- Unit tests for all migrated agents\n- Integration tests (multi-turn, memory persistence)\n- E2E tests (full Feishu workflow)\n- Performance regression testing\n\n### Phase 6: Cleanup (Day 11)\n- Remove ai-sdk-tools dependencies (if not used elsewhere)\n- Deprecate custom implementations\n- Update documentation and team knowledge base\n\n## Success Criteria\n\n1. ‚úÖ All 5 agents working with Mastra (unit test passing)\n2. ‚úÖ Memory fully transitioned (integration tests passing)\n3. ‚úÖ Observability provides equal or better insights\n4. ‚úÖ No regression in response times (performance tests)\n5. ‚úÖ All tests passing in CI/CD\n6. ‚úÖ Code review approved\n7. ‚úÖ Deployed to production with monitoring\n8. ‚úÖ ai-sdk-tools removed (if applicable)\n\n## Risk Mitigation\n\n1. **Keep both frameworks during transition** - Run tests against both implementations\n2. **Gradual rollout** - Migrate agents one by one, not all at once\n3. **Memory coexistence** - Support both memory backends during transition period\n4. **Rollback ready** - Keep ai-sdk-tools in package.json until fully validated in production\n5. **Monitoring** - Enhanced observability helps catch issues faster\n\n## External References\n\n- [Mastra Documentation](https://mastra.ai/docs)\n- [Mastra AI Tracing](https://mastra.ai/docs/observability/ai-tracing/overview)\n- [Langfuse Integration](https://mastra.ai/docs/observability/ai-tracing/exporters/langfuse)\n- [Mastra Memory System](https://mastra.ai/docs/memory)\n- [Current Implementation Plan](./MASTRA_MIGRATION_PLAN.md)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-02T12:48:49.721838+08:00","updated_at":"2025-12-02T12:49:08.849454+08:00","source_repo":"."}
{"id":"feishu_assistant-1tp","content_hash":"9b25a6afe00e2713894f3a09c677ed44235aed951d2ff6bef7520100c674ab28","title":"Phase 5b: Execute Real Message Test Scenarios","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.121548+08:00","updated_at":"2025-11-27T17:01:55.31386+08:00","closed_at":"2025-11-27T17:01:55.31386+08:00","source_repo":"."}
{"id":"feishu_assistant-25n","content_hash":"5dbcc8428df4cef3c929af7612c15ef31320818998bb81e5a018bddd6ecfef56","title":"feat: Document tracking observability (metrics, health checks, alerts)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:07:40.996282+08:00","updated_at":"2025-12-02T12:07:40.996282+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-25n","depends_on_id":"feishu_assistant-c0y","type":"parent-child","created_at":"2025-12-02T12:07:40.998681+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-280","content_hash":"704657e8478df9ee03340e28a20525e181a73e91507b79667c41b186b695bda9","title":"Phase 2: Testing, documentation, and reliability (1-2 weeks)","description":"\nPolish Phase 1 MVP to production-ready quality.\nDelivers: Comprehensive testing, full documentation, observability.\nSuccess: \u003e85% test coverage, zero crashes in 24h load test, full documentation.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:46:54.315937+08:00","updated_at":"2025-12-02T11:46:54.315937+08:00","source_repo":"."}
{"id":"feishu_assistant-29v","content_hash":"de7105ecad1730c2309070bc64531608f864bc990b5381b63c6bd5edfb310d8e","title":"Migrate DPA-PM Agent to Mastra framework","description":"# Migrate DPA-PM Agent to Mastra\n\n## Context\nDPA-PM Agent handles People/Capability management queries.\n\n## What Needs to Be Done\n1. Replace dpa-pm-agent.ts with Mastra version\n2. Update model array\n3. Keep tool definitions\n4. Update memory integration\n5. Delete dpa-pm-agent-mastra.ts\n\n## Files Involved\n- lib/agents/dpa-pm-agent.ts\n- lib/agents/dpa-pm-agent-mastra.ts (delete)\n- test/agents/*.test.ts (update)\n\n## Success Criteria\n- ‚úÖ Agent works\n- ‚úÖ Tests passing\n- ‚úÖ No regressions\n\n## Blocked By\n- Migrate Manager Agent\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:44.770439+08:00","updated_at":"2025-12-02T12:52:44.770439+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-29v","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.771329+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-2am","content_hash":"7ebf65c1d4ea78e6e5fb349005b6fd860ed152add12492417068e1e373694552","title":"Add test coverage for placeholder agents (alignment, P\u0026L, DPA PM)","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-20T17:42:59.674561+08:00","updated_at":"2025-11-20T17:42:59.674561+08:00","source_repo":"."}
{"id":"feishu_assistant-2c3","content_hash":"869b5a55afa62e0eb2ef0528a8af24afd9df7b6fee64c2069ab05a43e81ec149","title":"Phase 1 MVP: Core document tracking implementation (2-3 weeks)","description":"\nImplement minimum viable product for document tracking.\nDelivers: Basic polling, change detection, notifications, persistence, bot commands.\nSuccess: Can track 10+ docs, detects 90%+ of changes, zero false positives.\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:53.656031+08:00","updated_at":"2025-12-02T11:46:53.656031+08:00","source_repo":"."}
{"id":"feishu_assistant-2c4","content_hash":"c33a7b9eb01284dc536d823c7e513be8b2c245d89202a3d457f76eab37fbd852","title":"Phase 5b: Execute Real Message Test Scenarios","description":"Run test scenarios A-E (routing, multi-turn, isolation, performance, error handling). Phase 5a setup complete - ready for interactive testing. Server: Subscription Mode, Devtools: Enabled, Test Group: oc_cd4b98905e12ec0cb68adc529440e623, Test Script: scripts/phase-5-test.sh","notes":"Scenario A: PASS (after StarRocks fix). Agent routing works, response generated (10.3s), card sent. StarRocks table lookup now handles timestamped tables (okr_metrics_20251127). With fallback to DuckDB on error. Ready for Scenarios B-E testing.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.136755+08:00","updated_at":"2025-11-27T17:01:55.301626+08:00","closed_at":"2025-11-27T17:01:55.301626+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-2c4","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.137795+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-2jh","content_hash":"7235d29ae4c65eca0c8280a43f9d58c09d501b1b8d396005b58b95afd1bc6f9a","title":"Final validation and production rollout","description":"# Final Validation and Production Rollout\n\n## Context\nBefore deploying to production, final validation and planning.\n\n## What Needs to Be Done\n1. Validation checklist:\n   - ‚úÖ All unit tests passing\n   - ‚úÖ All integration tests passing\n   - ‚úÖ E2E tests passing\n   - ‚úÖ Performance tests passing\n   - ‚úÖ Code review approved\n   - ‚úÖ Bundle size acceptable\n   - ‚úÖ Documentation complete\n   \n2. Staging deployment:\n   - Deploy to staging environment\n   - Run smoke tests\n   - Monitor for 24 hours\n   - Verify Langfuse traces\n   - Verify memory persistence\n   \n3. Production rollout plan:\n   - Blue-green deployment\n   - Gradual rollout (10% ‚Üí 50% ‚Üí 100%)\n   - Rollback procedure if issues\n   - Monitoring and alerts configured\n   \n4. Post-deployment:\n   - Monitor error rates\n   - Monitor response times\n   - Monitor token usage\n   - Verify Langfuse data quality\n   \n5. Success declaration and retrospective\n\n## Files Involved\n- deployment scripts\n- monitoring config\n- rollback runbook\n\n## Success Criteria\n- ‚úÖ Staging validation passed\n- ‚úÖ Production deployment smooth\n- ‚úÖ No critical issues\n- ‚úÖ Monitoring active\n- ‚úÖ Team trained on new system\n\n## Blocked By\n- All prior tasks complete\n","notes":"Integration Phase 1 complete: Document command interception integrated into handle-app-mention.ts. All 71 tests passing (49 doc tracking + 22 integration). Ready for staging deployment validation.","status":"in_progress","priority":0,"issue_type":"task","created_at":"2025-12-02T12:52:46.408094+08:00","updated_at":"2025-12-02T16:33:25.103944+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-2jh","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:46.408862+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-2kq","content_hash":"9a8ef743aa516c8a2553d1754240ea8b38e846b7516788b599ccaa0f002f637f","title":"task: Memory integration for DocumentTracking (store/retrieve tracked docs)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:28:58.221928+08:00","updated_at":"2025-12-02T12:28:58.221928+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-2kq","depends_on_id":"feishu_assistant-i9s","type":"parent-child","created_at":"2025-12-02T12:28:58.223726+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-2s8","content_hash":"ff08de0b26771c1b57a82ae478c75872e634ab11d59863ea91a32717f99d21f1","title":"Configure real-time vs batch mode for tracing","description":"# Configure Real-Time vs Batch Tracing\n\n## Context\nDevelopment needs real-time tracing (instant feedback), production needs batch (efficiency).\n\n## What Needs to Be Done\n1. Verify observability config handles both modes:\n   - NODE_ENV=development ‚Üí real-time\n   - NODE_ENV=production ‚Üí batch\n   \n2. Test real-time mode:\n   - Run agent\n   - Verify traces in Langfuse within 1-2 seconds\n   \n3. Test batch mode:\n   - Run agents\n   - Verify traces batched (every 5-10 seconds)\n   - Lower network overhead\n   \n4. Measure impact:\n   - CPU overhead\n   - Memory usage\n   - Network bandwidth\n   - Latency (should not impact agent response)\n\n5. Document recommendations\n\n## Files Involved\n- lib/observability-config.ts (update)\n- docs/setup/langfuse-observability.md (update)\n\n## Success Criteria\n- ‚úÖ Real-time works in dev\n- ‚úÖ Batch works in prod\n- ‚úÖ No latency impact\n- ‚úÖ Network usage optimized\n\n## Blocked By\n- Configure Langfuse exporter\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:45.468502+08:00","updated_at":"2025-12-02T12:52:45.468502+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-2s8","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.469283+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-2s9","content_hash":"d1b11e73da82298c11181af6f6d2e3330d38acbc43dbc3d6ba785bdca9ce9af0","title":"Add retry logic with exponential backoff","description":"\nImplement retries:\n- 3 attempts max\n- Backoff: 100ms, 500ms, 2000ms\n- Only retry transient errors (not 403/404)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:55.30913+08:00","updated_at":"2025-12-02T11:46:55.30913+08:00","source_repo":"."}
{"id":"feishu_assistant-2wu","content_hash":"73aca323370e62064088cce5e12366e7f6bceab855e1bb2a93aea266abc28b7a","title":"Setup Langfuse tracing for all agents and tools","description":"# Setup Langfuse Tracing for Agents\n\n## Context\nLangfuse provides LLM-specific observability. Configure tracing for:\n- Agent executions\n- LLM calls (token usage, latency)\n- Tool executions\n- Memory operations\n\n## What Needs to Be Done\n1. Verify Langfuse exporter is configured (from Phase 1)\n2. Enable tracing on all agents:\n   - Manager agent\n   - All specialist agents\n3. Verify spans are created for:\n   - LLM calls (input/output tokens)\n   - Tool executions\n   - Memory queries\n4. Test in Langfuse dashboard:\n   - Traces appear\n   - Token counts correct\n   - Latency measured\n5. Set up monitoring alerts in Langfuse\n\n## Files Involved\n- lib/agents/*.ts (verify tracing enabled)\n- docs/setup/langfuse-observability.md (update)\n\n## Success Criteria\n- ‚úÖ All agents traced\n- ‚úÖ Langfuse dashboard shows data\n- ‚úÖ Token usage tracked\n- ‚úÖ Performance metrics visible\n\n## Related Tasks\n- Configure Langfuse exporter (Phase 1)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:45.354199+08:00","updated_at":"2025-12-02T12:52:45.354199+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-2wu","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.355141+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-2xz","content_hash":"b97c198f4515675f2bb90429cccd3351859a65292be7bfd25a8e9ed59b843009","title":"Add Mastra observability configuration to server.ts","description":"# Add Mastra Observability to Server\n\n## Context\nserver.ts is the entry point. We need to initialize Mastra's observability system here with PinoLogger and AI Tracing.\n\n## What Needs to Be Done\n1. Import Mastra observability modules in server.ts\n2. Initialize PinoLogger with appropriate log transports\n3. Create observability config object with:\n   - Service name (feishu-assistant)\n   - Environment detection (dev/staging/prod)\n   - Exporter configuration (Langfuse)\n   - Sampling rules (always in dev, 1% in prod)\n4. Pass to Mastra instance initialization\n5. Set up event listeners for trace emission\n\n## Technical Details\n- Use @mastra/core PinoLogger\n- Configure Langfuse exporter with env variables\n- Real-time export in development (NODE_ENV=development)\n- Batch export in production\n\n## Files Involved\n- server.ts (main changes)\n- lib/agents/manager-agent.ts (will use initialized Mastra)\n\n## Success Criteria\n- ‚úÖ Server initializes without errors\n- ‚úÖ Traces appear in development console\n- ‚úÖ PinoLogger outputs structured logs\n- ‚úÖ Environment detection works (dev/prod)\n\n## Blocked By\nNone\n\n## Blocks\n- Configure Langfuse AI Tracing exporter\n- Manager Agent migration\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:43.645983+08:00","updated_at":"2025-12-02T12:52:43.645983+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-2xz","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:43.647974+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-3gy","content_hash":"8d9f0cf3880b8f17c24f7d9aa0d0fed51024c0b15b9389b54b4b73b1017af736","title":"Phase 4d: Implement Devtools Event Filtering \u0026 Search","description":"Enable filtering and searching of devtools events for debugging and performance analysis.\n\nKEY DELIVERABLE: Powerful devtools API with filtering, searching, and pagination for event analysis.\n\nREASONING: As event volume grows, need ability to find relevant events quickly. Filtering by agent/type/error enables rapid debugging. Search enables finding patterns across agent responses.\n\nIMPLEMENTATION PLAN:\n1. Extend GET /devtools/api/events endpoint with query parameters\n2. Add filters: ?agent=Manager\u0026type=tool_call\u0026search=okr\n3. Implement pagination: ?limit=100\u0026offset=0\n4. Add sorting: ?sort=timestamp\u0026order=desc\n5. Combine filters (all conditions must match)\n\nACCEPTANCE CRITERIA:\n‚úì Filter by agent name: ?agent=Manager\n‚úì Filter by event type: ?type=tool_call|error|response\n‚úì Search event data: ?search=okr (searches content)\n‚úì Pagination works: ?limit=50\u0026offset=100\n‚úì Can combine multiple filters\n‚úì Performance acceptable with large event queues\n\nCONTEXT:\n- DevtoolsTracker stores events in array (max 1000 kept)\n- Event types: agent_call, tool_call, agent_handoff, error, response, etc.\n- Each event has: id, timestamp, type, agent, tool, data, duration, error, usage\n- Need to implement in server.ts HTTP handlers\n\nTECHNICAL NOTES:\n- devtools-integration.ts stores events in array\n- Filtering logic implemented in server.ts\n- For large queries, consider indexing or database storage\n- Pagination essential for UI performance\n- Keep last 1000 events to avoid unbounded memory\n\nFUTURE WORK:\n- Persistent event storage (database for historical analysis)\n- Advanced analytics (error rate trends, response time percentiles)\n- Custom event annotations/tagging\n- Event export (CSV, JSON for external analysis)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T15:15:20.458713+08:00","updated_at":"2025-11-27T15:26:45.109109+08:00","closed_at":"2025-11-27T15:26:45.109109+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-3gy","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:15:20.460218+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-411","content_hash":"4902d95aab69aa22db2c0c8205c9050761eacf82c274c3ced776888e0b250a4e","title":"Create /history/ directory for AI-generated planning documents","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-20T17:28:14.568586+08:00","updated_at":"2025-11-20T17:28:14.568586+08:00","source_repo":"."}
{"id":"feishu_assistant-428","content_hash":"889a9f869b3f856deda148565932193bc4e0a8fe00b712da0c307db3f2ea3398","title":"Test Mastra memory connection pooling and transactions","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:49:16.513181+08:00","updated_at":"2025-12-02T12:49:16.513181+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-428","depends_on_id":"feishu_assistant-kug","type":"blocks","created_at":"2025-12-02T12:49:16.514214+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-43s","content_hash":"8a9662370ada3165b966499d650bdf5bdaaf6e9caa33cf0b461947e67119896a","title":"[8/10] Write comprehensive documentation (user, dev, operator guides)","description":"\nCreate documentation for all audiences: users, developers, operators.\n\nüéØ GOAL: Self-documenting system with guides for all personas\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n\nDOCUMENTS TO CREATE:\n\n1. USER GUIDE (docs/USER_GUIDE.md)\n   - What is document tracking?\n   - How to use @bot watch/check/unwatch\n   - Examples with screenshots\n   - FAQs and troubleshooting\n   - Limits and best practices\n\n2. ARCHITECTURE GUIDE (docs/ARCHITECTURE.md)\n   - System overview (diagram)\n   - Component responsibilities\n   - Data flow\n   - Deployment architecture\n   - Scaling considerations\n\n3. API REFERENCE (docs/API_REFERENCE.md)\n   - All bot commands\n   - Response schemas\n   - Error codes\n   - Rate limits\n   - Webhook formats (future)\n\n4. DEVELOPER GUIDE (docs/DEVELOPER_GUIDE.md)\n   - How to extend with custom actions\n   - How to add new commands\n   - How to write tests\n   - Code structure\n   - Integration points\n\n5. OPERATOR GUIDE (docs/OPERATOR_GUIDE.md)\n   - Deployment steps\n   - Health checks\n   - Monitoring metrics\n   - Debugging issues\n   - Performance tuning\n   - Common problems + fixes\n\n6. TROUBLESHOOTING GUIDE (docs/TROUBLESHOOTING.md)\n   - Common issues and solutions\n   - Debug steps\n   - Log interpretation\n   - Recovery procedures\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- Documentation should be ahead of code changes\n- Each doc should be standalone but cross-reference others\n- Include examples and code snippets\n- Keep docs DRY (reference external files, don't duplicate)\n- Version docs with releases\n\nDOCUMENTATION STANDARDS:\n- Markdown format\n- Link all technical terms\n- Include diagrams (Mermaid or ASCII)\n- Code examples tested (kept in-sync)\n- Screenshots for UI features\n- Index/TOC in each doc\n\n‚úÖ SUCCESS CRITERIA:\n1. \u003e90% of code documented\n2. All commands documented with examples\n3. Setup instructions clear and tested\n4. Troubleshooting guide covers 80% of issues\n5. Developer can extend feature in 1 hour\n6. Operator can deploy/debug independently\n7. Zero technical debt in docs\n\n‚úÖ DOCUMENT CHECKLIST:\n- [ ] User guide complete with examples\n- [ ] Architecture diagrams clear\n- [ ] API reference exhaustive\n- [ ] Developer guide has setup section\n- [ ] Operator guide has all metrics\n- [ ] Troubleshooting answers top 5 issues\n- [ ] All docs pass spell check\n- [ ] Links all working\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 8 section\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:54.533251+08:00","updated_at":"2025-12-02T11:46:54.533251+08:00","source_repo":"."}
{"id":"feishu_assistant-49e","content_hash":"d8d198c07b06dce117e2877179109bd3d51a588c10878466b54022e12621f995","title":"TODO 5: Implement document content snapshots and diff engine","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:45:21.954266+08:00","updated_at":"2025-12-02T11:45:21.954266+08:00","source_repo":"."}
{"id":"feishu_assistant-4ir","content_hash":"370c8cbe36a830cf705236f29881f650b40a3c8d22d9f3c55b25b7676d329b7c","title":"Verify Mastra memory PostgreSQL connection and schema","description":"# Verify Mastra Memory PostgreSQL Connection\n\n## Context\nMastra memory backend uses PostgreSQL for persistent conversation storage. This task ensures:\n- Connection pooling works correctly\n- Schema matches Mastra expectations\n- Transaction handling is robust\n- RLS (row-level security) works\n\n## What Needs to Be Done\n1. Review existing memory-mastra.ts implementation\n2. Check PostgreSQL connection setup:\n   - Connection pool size (recommend 10-20)\n   - Timeout settings\n   - SSL/TLS if required\n   - Environment variable loading\n3. Verify schema:\n   - Tables exist (threads, messages, runs, etc.)\n   - Columns match Mastra types\n   - Indexes on critical columns (user_id, thread_id)\n   - JSONB fields for flexible metadata\n4. Test basic operations:\n   - Create test thread\n   - Insert message\n   - Query by user and thread\n   - Verify RLS isolation\n5. Document connection string format\n\n## Technical Details\n- Connection string format: postgres://user:password@host:port/database\n- Pool size impacts concurrency - too small causes stalls, too large wastes memory\n- RLS policy: threads.user_id = auth.uid()\n- Indexes: (user_id, thread_id), (created_at DESC)\n\n## Files Involved\n- lib/memory-mastra.ts (review implementation)\n- supabase/migrations/ (verify migrations applied)\n- scripts/test-mastra-memory.ts (new test script)\n\n## Success Criteria\n- ‚úÖ PostgreSQL connection established\n- ‚úÖ Schema verified and current\n- ‚úÖ Connection pooling configured\n- ‚úÖ RLS policies working\n- ‚úÖ Basic CRUD operations work\n- ‚úÖ Documentation updated\n\n## Blocked By\nNone\n\n## Blocks\n- Test Mastra memory connection pooling\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:44.006218+08:00","updated_at":"2025-12-02T12:52:44.006218+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-4ir","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.007545+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-4uy","content_hash":"40334748c58ed1b69877eb79f9067dff298c2f2e39cbb74407a28d2078c97930","title":"Phase 5e: Performance Analysis \u0026 Optimization","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.509669+08:00","updated_at":"2025-11-27T15:35:51.509669+08:00","source_repo":"."}
{"id":"feishu_assistant-4y1","content_hash":"864227d61507b53665a3f1229b3fd2328dd38dd309e14f90be06e1f7acbc3068","title":"Setup PinoLogger for structured logging","description":"# Setup PinoLogger for Structured Logging\n\n## Context\nReplace console.log with structured PinoLogger for production-grade logging. This provides:\n- Structured JSON logs\n- Log level filtering\n- Contextual metadata injection\n- Integration with Mastra's observability\n\n## What Needs to Be Done\n1. Create lib/logger-config.ts with PinoLogger setup\n2. Configure transports:\n   - File transport for production logs\n   - Console transport for development (pretty-printed)\n   - Optional: Upstash transport for cloud logging\n3. Set up context propagation (thread_id, user_id in logs)\n4. Update logging calls across codebase:\n   - Replace console.log with logger.info()\n   - Replace console.error with logger.error()\n   - Add contextual metadata (agent name, tool name, etc.)\n5. Add log levels (info, warn, error, debug)\n\n## Technical Details\n- Use @mastra/loggers FileTransport or UpstashTransport\n- Implement as singleton exported from logger-config.ts\n- Include run_id context for grouping multi-step operations\n- Respect LOG_LEVEL environment variable\n\n## Files Involved\n- lib/logger-config.ts (new)\n- lib/devtools-integration.ts (update to use logger)\n- lib/agents/*.ts (update logging calls)\n- server.ts (import and use logger)\n\n## Success Criteria\n- ‚úÖ Logger works in development and production\n- ‚úÖ All logging uses structured format\n- ‚úÖ Contextual data flows through logs\n- ‚úÖ Log filtering works by level\n\n## Related Tasks\n- Add Mastra observability to server.ts\n- Configure Langfuse exporter\n\n## Notes\nThis is foundational for observability - do this before agent migration.\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:43.767145+08:00","updated_at":"2025-12-02T12:52:43.767145+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-4y1","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:43.768228+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-520","content_hash":"984027f1d29618493a0f3f611b5bd36a4e74f454da604eb1f82eeece931f2892","title":"Organize documentation into /docs/ folder structure","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-20T17:28:09.797215+08:00","updated_at":"2025-11-20T17:28:09.797215+08:00","source_repo":"."}
{"id":"feishu_assistant-524","content_hash":"747e7487899959d9511a577514243249bc68eee4cf1e437051c154a31123af4a","title":"Fix: Memory context loading drops last history message","description":"When loading conversation history for context, .slice(0, -1) was removing the last message. This caused Q2 to be dropped when loading [Q1, A1, Q2]. Bot would only see [Q1, A1] and lose the most recent conversation turn. Fixed by including ALL loaded history messages in context.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-28T11:50:19.42027+08:00","updated_at":"2025-11-28T11:50:42.641175+08:00","closed_at":"2025-11-28T11:50:42.641175+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-524","depends_on_id":"feishu_assistant-lra","type":"discovered-from","created_at":"2025-11-28T11:50:19.421782+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-5aj","content_hash":"3587f5b865ba76bf1f36fc9a978b8e3bc83cb414a7efcf2560b77cd9983f1bc9","title":"Fix StarRocks okr_metrics table access - discovered during Phase 5b testing","description":"","notes":"Fixed: Now dynamically finds latest timestamped okr_metrics_XXXXXXXX table in StarRocks. Also has graceful fallback to DuckDB on error.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T16:29:03.03964+08:00","updated_at":"2025-11-27T16:44:47.994585+08:00","closed_at":"2025-11-27T16:44:47.994588+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-5aj","depends_on_id":"feishu_assistant-2c4","type":"discovered-from","created_at":"2025-11-27T16:29:03.041279+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-5dp","content_hash":"9596246fee9bddbaf9bde5b18e4781aa8135cdbef165bb99ac3501577b8fe208","title":"TODO 9: Implement comprehensive test suite (unit, integration, load, e2e)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:21.738426+08:00","updated_at":"2025-12-02T14:57:17.979203+08:00","closed_at":"2025-12-02T14:57:17.979203+08:00","source_repo":"."}
{"id":"feishu_assistant-5h4","content_hash":"21a75fde985da9d314cf534b9f81cb7fe009f1de662568c4bbf58bb74384a8ae","title":"Phase 5g: Monitoring \u0026 Alerting Setup","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.746078+08:00","updated_at":"2025-11-27T15:35:51.746078+08:00","source_repo":"."}
{"id":"feishu_assistant-5jn","content_hash":"05678643b332aed104318b25352a6f0b969c6793abe8d593b7a785abfa50476f","title":"Migrate Alignment Agent to Mastra framework","description":"# Migrate Alignment Agent to Mastra\n\n## Context\nAlignment Agent analyzes alignment between different OKR groups/departments.\n\n## What Needs to Be Done\n1. Replace alignment-agent.ts with Mastra version\n2. Update model array initialization\n3. Keep tool definitions\n4. Update memory integration\n5. Delete alignment-agent-mastra.ts\n\n## Files Involved\n- lib/agents/alignment-agent.ts\n- lib/agents/alignment-agent-mastra.ts (delete)\n- test/agents/*.test.ts (update)\n\n## Success Criteria\n- ‚úÖ Agent works with Mastra\n- ‚úÖ Tests passing\n- ‚úÖ No regressions\n\n## Blocked By\n- Migrate Manager Agent\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:44.541193+08:00","updated_at":"2025-12-02T12:52:44.541193+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-5jn","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.54229+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-5r8","content_hash":"ea53cda2244d7533b330222d62ab4be7259e09be7fe206a60601491aa1c13983","title":"task: Multi-turn conversation support for DocumentTracking agent","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-02T12:29:00.90461+08:00","updated_at":"2025-12-02T12:29:00.90461+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-5r8","depends_on_id":"feishu_assistant-i9s","type":"parent-child","created_at":"2025-12-02T12:29:00.906296+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-61u","content_hash":"96bbbd8fb3fb134694413a5a38a25384065e03e16074adf03f8029e52a1b9dda","title":"Debug: Feishu cardElement.create API validation - action element with buttons returning 99992402","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-21T11:48:06.309793+08:00","updated_at":"2025-11-21T12:19:48.869161+08:00","closed_at":"2025-11-21T12:19:48.869161+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-61u","depends_on_id":"feishu_assistant-6i7","type":"discovered-from","created_at":"2025-11-21T11:48:06.31093+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-6i7","content_hash":"ff323abaa9952c318c170d87e39b3b8dea692ddee6dd0a93ef93b20a339d8b45","title":"Suggestion cards not showing after response completes - finalizeCardWithFollowups not executing","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-20T19:36:22.215347+08:00","updated_at":"2025-11-21T12:05:44.497486+08:00","closed_at":"2025-11-21T12:05:44.497486+08:00","source_repo":"."}
{"id":"feishu_assistant-6ij","content_hash":"6c70308687cec00af9325068c485730cfe959e33fb2a7c3149b29a71e8632703","title":"Phase 5e: Performance Analysis \u0026 Optimization","description":"Measure response times, token usage, identify bottlenecks","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.571489+08:00","updated_at":"2025-11-27T15:36:01.571489+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-6ij","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.573444+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-6od","content_hash":"e8def652d1c25d09a69d13d3ed3f819d06538f497502fc7f99e650d7f73cdd7e","title":"Wire StarRocks RLS truth table","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-25T17:13:01.668771+08:00","updated_at":"2025-11-25T17:13:01.668771+08:00","source_repo":"."}
{"id":"feishu_assistant-6sr","content_hash":"470b4792b01b53b101f8c6de6b48f4ed16d758688b1f41b1f4dc32325e57fce8","title":"[3/10] Build DocumentPollingService with lifecycle management","description":"\nImplement polling loop that continuously monitors tracked documents.\n\nüéØ GOAL: Manage 10-100+ documents with reliable polling\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n- Singleton DocumentPollingService class\n- In-memory Map\u003cdocToken, TrackedDoc\u003e for tracking state\n- Polling interval: 30 seconds (configurable)\n- Batch requests: fetch up to 200 docs per call\n- Graceful error handling: one doc failing doesn't crash others\n- Exponential backoff on API errors\n- Lifecycle: startPolling(), stopPolling(), lifecycle hooks\n- Metrics: documents tracked, last poll time, error count\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- With 100 docs at 30s interval ‚Üí 3-4 API calls/minute (sustainable)\n- Memory: 100 docs √ó 1KB per state = ~100KB (trivial)\n- Process restart = lose tracked docs (mitigated by TODO 4 persistence)\n- Single-instance only for MVP (no multi-instance coordination yet)\n- API rate limiting: implement backoff + queue\n\nARCHITECTURE:\n‚îå‚îÄ DocumentPollingService ‚îÄ‚îê\n‚îÇ - trackedDocs Map        ‚îÇ\n‚îÇ - pollingInterval        ‚îÇ\n‚îÇ - config                 ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n         ‚Üì\n‚îå‚îÄ startPolling() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Every 30s:               ‚îÇ\n‚îÇ 1. Collect doc tokens    ‚îÇ\n‚îÇ 2. Batch request meta    ‚îÇ\n‚îÇ 3. Detect changes        ‚îÇ\n‚îÇ 4. Dispatch notify()     ‚îÇ\n‚îÇ 5. Update state          ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n‚úÖ SUCCESS CRITERIA:\n1. Can track 10, 100, 1000+ documents\n2. Never blocks event loop (async/await)\n3. Handles partial failures (some docs fail, others continue)\n4. Memory usage \u003c200MB at 100 docs\n5. CPU usage \u003c5% at idle (100 docs)\n6. Startup/shutdown clean with no leaks\n7. Metrics exposed for monitoring\n\n‚úÖ CONFIGURATION:\ninterface PollingConfig {\n  intervalMs: 30000,\n  maxConcurrentPolls: 100,\n  batchSize: 200,\n  retryAttempts: 3,\n  retryBackoffMs: [100, 500, 2000],\n  debounceWindowMs: 5000\n}\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 3 section\n- FEISHU_DOC_TRACKING_INVESTIGATION.md Section 5 (architecture diagram)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:53.984487+08:00","updated_at":"2025-12-02T11:46:53.984487+08:00","source_repo":"."}
{"id":"feishu_assistant-77l","content_hash":"85f8a3bddc6015e6195825715f9c6f00c4d0b4d9de13b07abbaf43ddf1882ddb","title":"Complete Mastra Memory message persistence implementation","description":"## Current Status\n\n‚úÖ Mastra Memory 3-layer architecture is initialized\n‚úÖ PostgreSQL storage connected (Supabase)\n‚úÖ User and thread scoping configured\n‚úÖ Legacy memory system disabled (was causing conflicts)\n\n## Problem\n\nMemory is created but messages are NOT persisting between calls:\n- Q1: 'What is OKR?' ‚Üí gets response (635 chars)\n- Q2: 'Tell me more about KRs' ‚Üí doesn't have context from Q1\n\nLog shows: \n```\n[Manager] Loading conversation history from Mastra Memory...\n[Manager] Failed to load memory context: warn: No thread found\n```\n\n## Root Cause\n\nMastra Memory requires explicit message storage. Currently:\n1. Memory instance is created ‚úÖ\n2. Messages are NOT being saved to it ‚ùå\n3. query() throws 'No thread found' error ‚ùå\n\n## Solution Required\n\nImplement proper message persistence using Mastra Memory's API:\n\n1. **Save user message to memory** after each query\n   ```typescript\n   await mastraMemory.saveMessage({\n     threadId: memoryThread,\n     resourceId: memoryResource,\n     role: 'user',\n     content: query,\n   });\n   ```\n\n2. **Save assistant response to memory**\n   ```typescript\n   await mastraMemory.saveMessage({\n     threadId: memoryThread,\n     resourceId: memoryResource,\n     role: 'assistant',\n     content: text,\n   });\n   ```\n\n3. **Verify query() works after messages exist**\n   - Should return conversation history\n   - Enable semantic recall\n\n## Testing\n\nNeed to test full conversation flow:\n1. User Q1 ‚Üí Bot saves to memory\n2. User Q2 ‚Üí Bot loads Q1 context from memory\n3. Memory enables follow-up questions\n\n## Files to Update\n\n- `lib/agents/manager-agent-mastra.ts` - Add message save calls\n- Check Mastra Memory API for correct saveMessage() signature\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-28T14:11:06.431107+08:00","updated_at":"2025-11-28T14:24:56.118368+08:00","closed_at":"2025-11-28T14:24:56.118368+08:00","source_repo":"."}
{"id":"feishu_assistant-78y","content_hash":"c9182c646b60d266c945f12e063b5acb7979e578802b9dff3080f34bcadbd064","title":"task: DocumentTracking agent skeleton (lib/agents/document-tracking-agent.ts)","description":"","notes":"Document tracking test suite: all 49 tests passing (19 unit + 13 poller + 17 integration). Build successful 5.7mb bundle. Timestamp formatting issues fixed. Ready for production validation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-02T12:28:51.746462+08:00","updated_at":"2025-12-02T16:20:22.793076+08:00","closed_at":"2025-12-02T16:20:22.79308+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-78y","depends_on_id":"feishu_assistant-i9s","type":"parent-child","created_at":"2025-12-02T12:28:51.74782+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-7xv","content_hash":"b78af36e9a8161664465f8b5cc2cb73cc6f8dac28cdb61114067cdd91ac34f38","title":"Implement card action handling for interactive card buttons","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-20T17:38:01.920402+08:00","updated_at":"2025-11-20T17:47:34.568098+08:00","closed_at":"2025-11-20T17:47:34.568098+08:00","source_repo":"."}
{"id":"feishu_assistant-8lc","content_hash":"2d072574ce2927118fd813d4a4e658c7cf09f16bea692c7c455d192b380cb6b0","title":"Phase 3: Advanced features and optimizations (2-3 weeks)","description":"\nAdd advanced capabilities and performance optimizations.\nDelivers: Content snapshots, rules engine, multi-channel, advanced metrics.\nSuccess: 1000 docs, \u003c5% CPU, rich automation capabilities.\n","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-02T11:46:54.644058+08:00","updated_at":"2025-12-02T11:46:54.644058+08:00","source_repo":"."}
{"id":"feishu_assistant-8t6","content_hash":"f01b521c526e5a223f406f13c64fe785d74812b12acd7eba75bb4d8120d6f48e","title":"Text-based follow-up suggestions implementation in progress - debugging LLM generation and streaming mode issues","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-21T12:41:05.1981+08:00","updated_at":"2025-11-21T12:48:08.708269+08:00","closed_at":"2025-11-21T12:48:08.708269+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-8t6","depends_on_id":"feishu_assistant-kjl","type":"discovered-from","created_at":"2025-11-21T12:41:05.198934+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-9gb","content_hash":"b856be6798ace79587e0c55bbded72ab4709be24a46a9ff98bf3186105e9df94","title":"TODO 10: Add metrics, monitoring, and performance optimization","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:45:22.176336+08:00","updated_at":"2025-12-02T11:45:22.176336+08:00","source_repo":"."}
{"id":"feishu_assistant-9im","content_hash":"ffbae63e1dde4f450e44184468d767b849d95f2ff681273f638a5a7579f5a688","title":"Server startup failures and WebSocket connection issues - ROOT PROBLEM","description":"## PROBLEM STATEMENT\n\nServer startup and WebSocket connection has been unstable throughout development sessions. The root cause has not been properly diagnosed or fixed. We need to systematically identify and resolve the underlying issues.\n\n## WHAT WE'VE OBSERVED\n\n1. **Intermittent Startup Failures**: Server sometimes starts successfully, sometimes hangs\n2. **WebSocket Connection Issues**: Connection appears to establish but reliability is uncertain\n3. **Long Debugging Sessions**: We've spent extended time testing buttons, checking logs, restarting servers without identifying the root cause\n4. **Manual Workarounds**: We're using nohup, pid files, sleep commands - signs of working around problems rather than fixing them\n\n## IMPACT\n\n- Cannot reliably start the server for testing\n- Unclear if production deployment will have similar issues\n- Development velocity severely impacted by restarts and debugging\n- No clear diagnostic tools to understand what's happening\n\n## AREAS TO INVESTIGATE\n\n### 1. Server Startup Process\n- [ ] Check if initial WebSocket connection is blocking server startup\n- [ ] Look at initialization order in server.ts\n- [ ] Verify all dependencies are loaded before listening on port 3000\n- [ ] Check for race conditions in async initialization\n\n### 2. WebSocket Connection Handling\n- [ ] Verify Feishu SDK setup and initialization\n- [ ] Check if event-dispatch is fully ready before accepting events\n- [ ] Look at error handling for failed connections\n- [ ] Determine if WebSocket reconnection logic is working\n\n### 3. Environment and Dependencies\n- [ ] Verify Supabase is optional or gracefully skipped\n- [ ] Check if missing env vars are properly handled\n- [ ] Review all external service dependencies\n\n### 4. Logging and Diagnostics\n- [ ] Add detailed startup phase logging\n- [ ] Log WebSocket lifecycle events (connecting, connected, reconnecting, failed)\n- [ ] Add health check endpoint that shows detailed status\n- [ ] Log timing information to identify bottlenecks\n\n## ACCEPTANCE CRITERIA\n\n- [ ] Server starts reliably 100% of the time (no hangs, no race conditions)\n- [ ] WebSocket connection status is clearly visible in logs\n- [ ] Health endpoint shows detailed startup and connection status\n- [ ] Can diagnose connection failures without inspecting code\n- [ ] Startup time is documented and predictable (\u003c10s)\n\n## TECHNICAL NOTES\n\n- Current startup code in server.ts appears to initialize WebSocket and Feishu SDK\n- Subscription Mode is being used (long-lived WebSocket instead of webhook polling)\n- There's a 5-8 second wait in AGENTS.md noted as \"startup time\" but actual behavior varies\n- No explicit timeout handling for WebSocket connection establishment\n\n## NEXT STEPS\n\n1. Add detailed logging to server.ts startup sequence\n2. Create startup verification tests\n3. Document expected startup phases and timing\n4. Add explicit error handling for connection failures\n5. Verify all startup warnings can be safely ignored","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-20T19:01:22.366615+08:00","updated_at":"2025-11-20T19:03:55.023249+08:00","closed_at":"2025-11-20T19:03:55.023249+08:00","source_repo":"."}
{"id":"feishu_assistant-9ls","content_hash":"ac6d4398d825500c2f1e5bb670beb38fde74d5e72501f4e57dd92e140115688a","title":"Server startup still slow or failing - investigate and fix","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-20T18:45:22.439447+08:00","updated_at":"2025-11-20T18:53:34.933763+08:00","closed_at":"2025-11-20T18:53:34.933763+08:00","source_repo":"."}
{"id":"feishu_assistant-9no","content_hash":"9ff9c8f2a1e5757b0a038fbb7913197cc2dfac62f1e305da481f38930620f1ed","title":"Configure Langfuse AI Tracing exporter (development mode)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:49:16.135358+08:00","updated_at":"2025-12-02T12:49:16.135358+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-9no","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:49:16.136562+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-aid","content_hash":"7676697d1fee71f9853bb83d0d4321d2b92837a8ac9ab71496d3c04924f9d225","title":"Phase 1: MVP - Core document tracking implementation","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:20.848805+08:00","updated_at":"2025-12-02T11:45:20.848805+08:00","source_repo":"."}
{"id":"feishu_assistant-aps","content_hash":"365b0d6d231ebfa04f0bb86ff4654d882f406f769844b2767fcf0de453abe9b0","title":"Investigate and fix socket connection reset in threading","description":"","status":"open","priority":2,"issue_type":"bug","created_at":"2025-11-20T17:42:50.02121+08:00","updated_at":"2025-11-20T17:42:50.02121+08:00","source_repo":"."}
{"id":"feishu_assistant-bdb","content_hash":"ec3df32c30b2102d0003fa8d08585339b12c3213870d3bb658ed90cdd004b981","title":"Migrate Manager Agent to Mastra framework","description":"# Migrate Manager Agent to Mastra\n\n## Context\nManager Agent is the orchestrator that routes queries to specialist agents. Migration to Mastra eliminates dual-agent pattern and simplifies routing.\n\n## Current Implementation\n- Dual agents: primary (OpenRouter) + fallback (OpenAI)\n- Manual handoff routing to specialists (OKR, Alignment, P\u0026L, DPA-PM)\n- Custom devtools tracking\n- ai-sdk-tools/memory integration\n\n## Target Implementation\n- Single agent with model array: [primary, fallback]\n- Native Mastra agent switching (simpler routing)\n- Native observability via AI Tracing\n- Mastra memory integration\n\n## What Needs to Be Done\n1. Create lib/agents/manager-agent.ts (from manager-agent-mastra.ts)\n   - Replace ai-sdk-tools Agent with Mastra Agent\n   - Update model initialization from dual agents to array\n   - Simplify tool registration\n   \n2. Update instructions and tools:\n   - Keep existing instructions logic\n   - Verify tool signatures still work\n   - Update memory loading to use Mastra memory\n   \n3. Update imports in generate-response.ts:\n   - Import from new manager-agent.ts\n   \n4. Remove old manager-agent-mastra.ts after validation\n\n## Implementation Details\n- Model array: [getPrimaryModel(), getFallbackModel()]\n- Mastra handles retry logic automatically\n- Use getMemoryThread() from memory-mastra.ts\n- Pass chatId, rootId as execution context\n\n## Files Involved\n- lib/agents/manager-agent.ts (replace entire file)\n- lib/agents/manager-agent-mastra.ts (delete after validation)\n- lib/generate-response.ts (update imports - 1 line)\n- test/agents/manager-agent.test.ts (update tests)\n\n## Success Criteria\n- ‚úÖ Manager agent initializes without errors\n- ‚úÖ Responds to queries\n- ‚úÖ Routes to specialists correctly\n- ‚úÖ Memory integration works\n- ‚úÖ Tests passing\n- ‚úÖ No regression in response quality\n\n## Blocked By\n- Add Mastra observability to server.ts\n- Configure Langfuse exporter\n\n## Blocks\n- Migrate OKR Reviewer Agent\n- Migrate Alignment Agent\n- Migrate P\u0026L Agent\n- Migrate DPA-PM Agent\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:44.309647+08:00","updated_at":"2025-12-02T12:52:44.309647+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-bdb","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.310618+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-bk6","content_hash":"38feeb3f07957f7e5705a39eb45b6995b94d6bef1d1665c195f7249bd90a2a92","title":"TODO 6: Build rules engine for conditional actions and reactions","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:45:22.061307+08:00","updated_at":"2025-12-02T11:45:22.061307+08:00","source_repo":"."}
{"id":"feishu_assistant-btv","content_hash":"5718c7e2554b1de1237fc4a2f88a208dc21cb68c732e9ff55df7033dd958bf1c","title":"Phase 4e: Integration Test - Multi-Turn Conversations","description":"Verify agents handle multi-turn conversations correctly with proper context awareness and memory isolation.\n\nKEY DELIVERABLE: Comprehensive integration test proving context persistence works in realistic scenarios.\n\nREASONING: Multi-turn context is core feature. Must verify implementation actually works before deployment. Tests prevent regressions if memory system modified.\n\nIMPLEMENTATION PLAN:\n1. Create test with 3+ consecutive agent calls (same chat/user)\n2. Q1: 'What is OKR?' ‚Üí A1: Standard definition\n3. Q2: 'How many metrics?' ‚Üí A2: Should reference previous discussion\n4. Q3: 'Analyze my team' ‚Üí A3: Should use accumulated context\n5. Verify different users/chats have isolated memory\n\nACCEPTANCE CRITERIA:\n‚úì Multi-turn OKR queries maintain context between calls\n‚úì Agent references or acknowledges previous messages\n‚úì Different chat IDs don't share memory\n‚úì Different users don't see each other's conversations\n‚úì Works with realistic Feishu context (chatId, rootId, userId)\n\nTEST SCENARIOS:\nScenario 1: Simple Context Awareness\n  Input 1: 'What is OKR?'\n  Input 2: 'How many metrics in my team?' (should remember OKR context)\n  Verify: A2 shows awareness of Q1\n\nScenario 2: User Isolation\n  User A asks Q about OKRs ‚Üí stores in User A memory\n  User B asks same Q ‚Üí should NOT see User A's prior responses\n  Verify: Different responses for same question by different users\n\nScenario 3: Thread Isolation\n  Same chat, but rootId changes (different threads)\n  Thread 1: Q about OKRs\n  Thread 2: Same question (should not remember Thread 1)\n  Verify: Separate memory per rootId\n\nIMPLEMENTATION:\n- Write in manager-agent-mastra.test.ts or new integration-test.ts\n- Pattern: 3 calls with same chatId/rootId, different questions\n- Check conversation history loaded before second call\n- Verify memory isolation with different IDs\n\nKNOWN ISSUES:\n- Tests may timeout due to API latency (5+ seconds each)\n- Memory writes may fail in test environment (expected, caught gracefully)\n- DrizzleProvider may error (but falls back to InMemory)\n\nCONTEXT:\n- Memory initialization done (manager-agent-mastra.ts:166-182)\n- loadConversationHistory() loads last 5 messages\n- saveMessageToMemory() saves user and assistant messages\n- Memory scoped by: feishu:${chatId}:${rootId} and user:${userId}","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:15:20.612279+08:00","updated_at":"2025-11-27T15:28:43.250798+08:00","closed_at":"2025-11-27T15:28:43.250798+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-btv","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:15:20.613342+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-bu7","content_hash":"05951598cdee829b7dd1ad8e47fb2d486952b7ada7a4aee54f992de4445503c8","title":"Add Mastra observability configuration to server.ts","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:49:15.743561+08:00","updated_at":"2025-12-02T12:49:15.743561+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-bu7","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:49:15.745275+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-c0y","content_hash":"6ffa2fcec721c0fc539c786f8f78b2fe0950fafe07bfe491de42be3f380326b4","title":"feat: Feishu document change tracking system (Epic)","description":"\nEnable real-time monitoring of Feishu document changes with bot-driven notifications.\nThis epic implements a complete document tracking system that:\n- Polls Feishu documents for changes (who modified, when)\n- Detects changes using metadata comparison\n- Sends notifications to groups when changes detected\n- Provides bot commands for users to manage tracking\n- Persists state across restarts\n- Provides observability/metrics\n\nThis serves core project goals of enhanced collaboration awareness and demonstrates advanced SDK integration.\n\nSee FEISHU_DOC_TRACKING_INVESTIGATION.md and FEISHU_DOC_TRACKING_ELABORATION.md for complete context.\n","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-12-02T11:46:53.538018+08:00","updated_at":"2025-12-02T12:07:34.853017+08:00","source_repo":"."}
{"id":"feishu_assistant-c1j","content_hash":"bf7b9ebe4acdc053b1a60a33e90906e7a824802ad8d7565fd814f24bb8da7beb","title":"Remove ai-sdk-tools dependencies from package.json","description":"# Remove ai-sdk-tools Dependencies\n\n## Context\nOnce migration complete, remove old framework to reduce dependencies and bundle size.\n\n## What Needs to Be Done\n1. Verify no remaining ai-sdk-tools imports:\n   - grep -r '@ai-sdk-tools' lib/ test/ server.ts\n   - Should return 0 results\n   \n2. Remove from package.json:\n   - @ai-sdk-tools/agents\n   - @ai-sdk-tools/memory\n   - @ai-sdk-tools/cache (if not used elsewhere)\n   - Any other @ai-sdk-tools packages\n   \n3. Run tests to verify nothing broken\n4. Update documentation\n5. Measure bundle size reduction\n\n## Files Involved\n- package.json (remove deps)\n- bun.lock (will be regenerated)\n\n## Success Criteria\n- ‚úÖ All deps removed\n- ‚úÖ No import errors\n- ‚úÖ Tests still passing\n- ‚úÖ Bundle size reduced\n\n## Blocked By\n- All migrations complete\n- All tests passing\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:46.178336+08:00","updated_at":"2025-12-02T12:52:46.178336+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-c1j","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:46.179103+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-c6a","content_hash":"e9d591ba5f99c6119a04e0397d96fb82ea6e80e584c1d52f0fe24bc11769f2e3","title":"[4/10] Add Supabase persistence for tracked documents","description":"\nImplement persistent storage of document tracking state.\n\nüéØ GOAL: Survive server restarts and enable multi-instance support\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n- Supabase tables:\n  * document_tracking: { docToken, docType, chatId, startedAt, isActive, ... }\n  * document_changes: { docToken, prevUser, newUser, prevTime, newTime, detectedAt, ... }\n- Load tracked docs from DB on startup\n- Sync state to DB every 5 minutes (batched)\n- Audit trail of all changes detected\n- Multi-instance support: use database as source of truth\n\nDATABASE SCHEMA:\nTable: document_tracking\n  - id UUID PK\n  - doc_token STRING UNIQUE\n  - doc_type STRING (doc, sheet, bitable, docx)\n  - chat_id_to_notify STRING\n  - started_tracking_at TIMESTAMP\n  - last_modified_user STRING\n  - last_modified_time INTEGER (unix ts)\n  - is_active BOOLEAN\n  - created_by_user_id STRING\n  - created_at TIMESTAMP\n  - updated_at TIMESTAMP\n\nTable: document_changes (Audit trail)\n  - id UUID PK\n  - doc_token STRING FK\n  - previous_modified_user STRING\n  - new_modified_user STRING\n  - previous_modified_time INTEGER\n  - new_modified_time INTEGER\n  - change_detected_at TIMESTAMP\n  - notification_sent BOOLEAN\n  - notification_message_id STRING\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- In-memory Map stays for speed (polling performance)\n- DB used for durability + audit\n- Sync delay acceptable: 5 minute batches OK\n- Audit trail crucial for debugging and analytics\n- Schema migration handling (alembic/knex)\n\nHYBRID APPROACH:\n‚îå‚îÄ Memory (Fast) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Map\u003ctoken, state\u003e    ‚îÇ ‚Üê Used for polling\n‚îÇ Updated in real-time ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n         ‚Üì (every 5 min)\n‚îå‚îÄ Database (Durable) ‚îÄ‚îê\n‚îÇ Supabase tables      ‚îÇ ‚Üê Source of truth\n‚îÇ Survives restart     ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n         ‚Üë (on startup)\n‚îÇ Reload on startup   ‚îÇ\n\n‚úÖ SUCCESS CRITERIA:\n1. Tracked docs restored after server restart\n2. Audit trail complete and queryable\n3. Schema migrations working\n4. No data loss on restart\n5. Multi-instance reads don't conflict\n6. Audit trail queries \u003c100ms (indexed)\n\n‚úÖ TESTING:\n1. Create tracking, restart server, verify still tracked\n2. Generate 100 changes, verify all in audit trail\n3. Multi-instance: start 2 servers, verify consistency\n4. Schema migration: test upgrade path\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 4 section (Persistence Layer)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:54.094869+08:00","updated_at":"2025-12-02T11:46:54.094869+08:00","source_repo":"."}
{"id":"feishu_assistant-clm","content_hash":"4febeff3b1bf3aab251ff84c3b88135c34734ccad93fdef5f462a137dcf3d963","title":"Verify Row-Level Security (RLS) for multi-user isolation","description":"# Verify RLS for Multi-User Isolation\n\n## Context\nRLS ensures users can only access their own conversations. Critical for security.\n\n## What Needs to Be Done\n1. Review RLS policies:\n   - Policies in PostgreSQL for threads table\n   - Policies for messages table\n   - Check for any gaps\n\n2. Test RLS isolation:\n   - Create two test users\n   - Insert conversations for each\n   - Verify user A cannot see user B's data\n   - Verify admin bypass works (if applicable)\n\n3. Test RLS under load:\n   - Concurrent queries from different users\n   - Verify no data leaks under stress\n\n4. Document RLS strategy:\n   - How user_id is determined\n   - How RLS policy is applied\n   - Any exceptions or special cases\n\n5. Add RLS tests to test suite\n\n## Technical Details\n- RLS policy: threads.user_id = auth.uid()\n- Use Supabase RLS or PostgreSQL native RLS\n- Test with different user roles\n\n## Files Involved\n- supabase/migrations/ (RLS policies)\n- test/integration/rls-isolation.test.ts (new)\n- docs/security/rls-strategy.md (new)\n\n## Success Criteria\n- ‚úÖ RLS policies in place\n- ‚úÖ Isolation tests passing\n- ‚úÖ No data leaks possible\n- ‚úÖ Performance acceptable (\u003c50ms queries)\n\n## Blocked By\n- Transition conversation history to Mastra memory\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:45.112638+08:00","updated_at":"2025-12-02T12:52:45.112638+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-clm","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.113533+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-cm9","content_hash":"41cbf0bbe584accc1065e8d95804b69edff5f0b3821c79f85f5935cec223927c","title":"Phase 5a: Setup Test Feishu Environment","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:50.99532+08:00","updated_at":"2025-11-27T15:35:50.99532+08:00","source_repo":"."}
{"id":"feishu_assistant-crm","content_hash":"d30718ad75a27b81ae623d73c2cc73b2e1391eda10726dd19396cd3ed423c508","title":"TODO 7: Implement bot commands (watch, check, unwatch, watched)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:21.409023+08:00","updated_at":"2025-12-02T14:50:13.812108+08:00","closed_at":"2025-12-02T14:50:13.812108+08:00","source_repo":"."}
{"id":"feishu_assistant-csn","content_hash":"6ffd96cd442f81b22c5658c02ccf847576bf009040f8947286f629350a87231b","title":"Phase 5f: Phased Rollout Execution","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.624962+08:00","updated_at":"2025-11-27T15:35:51.624962+08:00","source_repo":"."}
{"id":"feishu_assistant-cw2","content_hash":"00d168ac420f13ccb0bf0615ce6d8d054bc63b38eb4c23766891c17d157bac99","title":"Transition conversation history to Mastra memory backend","description":"# Transition Conversation History to Mastra Memory\n\n## Context\nCurrently using ai-sdk-tools memory with Supabase. Need to transition to Mastra memory with PostgreSQL.\n\n## What Needs to Be Done\n1. Analyze existing conversation data\n   - Count conversations\n   - Identify data patterns\n   - Plan migration strategy\n\n2. Create migration script:\n   - Read from ai-sdk-tools memory (Supabase)\n   - Write to Mastra memory (PostgreSQL)\n   - Verify data integrity\n   - Log migration stats\n\n3. Update memory loading in agents:\n   - All agents load from Mastra memory\n   - Fall back to ai-sdk-tools if needed (during transition)\n   \n4. Verify dual-read works:\n   - Read from both backends\n   - Compare results\n   - Ensure consistency\n\n5. Test in staging environment\n6. Execute migration in production\n\n## Implementation Details\n- Migration script: scripts/migrate-memory.ts\n- Read ai-sdk-tools memory from lib/memory.ts\n- Write to Mastra memory from lib/memory-mastra.ts\n- Validate each conversation transfer\n- Rollback script if needed\n\n## Files Involved\n- scripts/migrate-memory.ts (new)\n- lib/memory.ts (keep for reading old data)\n- lib/memory-mastra.ts (write new data)\n- lib/agents/memory-integration.ts (dual-read logic)\n\n## Success Criteria\n- ‚úÖ All conversations migrated\n- ‚úÖ Data integrity verified\n- ‚úÖ No loss of context\n- ‚úÖ Dual-read tests passing\n- ‚úÖ Migration stats logged\n\n## Related Tasks\n- Verify RLS for multi-user isolation\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:45.001786+08:00","updated_at":"2025-12-02T12:52:45.001786+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-cw2","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.002874+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-d2v","content_hash":"800c043549250ca3999364910dd433528f58c77fad70f630e31b4787c6c866a6","title":"Rewrite agent framework using Mastra instead of AI SDK Tools","description":"","status":"in_progress","priority":2,"issue_type":"feature","created_at":"2025-11-27T14:17:12.036902+08:00","updated_at":"2025-11-27T14:29:57.239019+08:00","source_repo":"."}
{"id":"feishu_assistant-d7z","content_hash":"6e9e85f2382e5064811177116e82a0cb0426a91a5e4785cb290a45c46fec82df","title":"Phase 4h: Plan Phase 5 - Real Feishu Integration Testing","description":"Create comprehensive plan for Phase 5: Real Feishu integration testing and validation.\n\nKEY DELIVERABLE: Detailed Phase 5 epic with subtasks, success criteria, and rollout strategy.\n\nREASONING: Phase 5 is transition from lab to production. Must plan carefully to:\n1. Avoid breaking changes to existing Feishu workflows\n2. Validate all features work in real scenarios\n3. Establish monitoring and rollback strategy\n4. Build confidence in system reliability\n\nIMPLEMENTATION PLAN:\n1. Document real Feishu testing scenarios\n2. Define success criteria per scenario\n3. Create Phase 5 epic in beads\n4. Design rollout approach (1 user ‚Üí group ‚Üí all)\n5. Define monitoring/alerting requirements\n6. Create rollback procedure\n\nACCEPTANCE CRITERIA:\n‚úì Phase 5 epic created with detailed description\n‚úì 6-8 child tasks for Phase 5 work defined\n‚úì Test scenarios documented (with Feishu webhooks)\n‚úì Success criteria for each scenario\n‚úì Rollout strategy defined (phased approach)\n‚úì Devtools monitoring approach specified\n‚úì Rollback procedure documented\n‚úì Effort estimated (4-6 hours)\n\nPHASE 5 OVERVIEW:\n\n**Goal**: Validate complete Feishu integration with memory + devtools in production-like environment\n\n**Timeline**: ~4-6 hours\n**Risk Level**: Medium (touches Feishu integration)\n**Rollback Plan**: Use feature flags to disable Mastra agents, revert to old implementation\n\n**PHASE 5 SUBTASKS**:\n- P5a: Setup test Feishu environment (dedicated group for testing)\n- P5b: Create end-to-end test scenarios (message ‚Üí routing ‚Üí response)\n- P5c: Test memory persistence with real Feishu messages\n- P5d: Monitor devtools during real usage (token usage, errors)\n- P5e: Performance testing (response time, throughput)\n- P5f: Rollout strategy - 1 user ‚Üí 10 users ‚Üí all users\n- P5g: Monitoring \u0026 alerting setup\n- P5h: Documentation \u0026 release notes\n\n**SUCCESS CRITERIA**:\n- All agents respond correctly to real Feishu messages\n- Memory persists and improves response quality\n- Token costs within budget (\u003c$X per day)\n- Response time acceptable (\u003c10s for 95th percentile)\n- No memory leaks or runaway errors\n- Devtools shows all expected events\n- Zero data loss or corruption\n\n**ROLLOUT STRATEGY**:\nPhase 1 (Day 1): Test with single team member\n  - All features enabled\n  - Heavy devtools monitoring\n  - Prepare to rollback anytime\n  \nPhase 2 (Day 2): Test with team group (5-10 users)\n  - Real workflow testing\n  - Monitor memory usage\n  - Check token costs\n  \nPhase 3 (Day 3): Full rollout to all users\n  - Gradual (10% ‚Üí 50% ‚Üí 100%)\n  - Kill switch ready\n  - Continuous monitoring\n\n**MONITORING REQUIREMENTS**:\n- Agent error rate (should be \u003c1%)\n- Token costs per agent per day\n- Response time p50/p95/p99\n- Memory usage over time\n- Feishu message delivery success rate\n- Devtools event volume\n\n**ROLLBACK PROCEDURE**:\nIf critical issues:\n1. Disable Mastra agents (feature flag)\n2. Revert to original implementation\n3. Investigate issue\n4. Deploy fix\n5. Re-enable gradually\n\nCONTEXT:\n- Phases 2-4 complete: All agents migrated + tested\n- Phase 5 validates production readiness\n- Phase 6 will be final cleanup + release\n- Real Feishu messages critical for validation\n- Memory + devtools must work in production context","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:15:41.766067+08:00","updated_at":"2025-11-27T15:35:31.226926+08:00","closed_at":"2025-11-27T15:35:31.226926+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-d7z","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:15:41.767544+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-dg6","content_hash":"1064056a154c283bb84240db04bd818883b7008f12dbce0d4752fef057b2d54a","title":"Performance regression testing","description":"# Performance Regression Testing\n\n## Context\nEnsure Mastra doesn't cause performance degradation.\n\n## What Needs to Be Done\n1. Baseline performance (ai-sdk-tools):\n   - Measure agent response latency\n   - Token count accuracy\n   - Memory query time\n   - Total E2E latency\n   \n2. Measure Mastra performance:\n   - Same metrics as baseline\n   - Compare results\n   \n3. Acceptable targets:\n   - Response latency: \u003c5 seconds (same as before)\n   - Memory queries: \u003c50ms (same as before)\n   - Token counting: 100% accurate\n   \n4. If slower:\n   - Profile to find bottleneck\n   - Optimize (may need db indexes, connection pooling)\n   \n5. Document results\n\n## Files Involved\n- scripts/performance-test.ts (new or update)\n\n## Success Criteria\n- ‚úÖ No regression in latency\n- ‚úÖ Token counting accurate\n- ‚úÖ Memory queries fast\n- ‚úÖ Results documented\n\n## Blocked By\n- All agent migrations\n- Memory transition complete\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:46.058939+08:00","updated_at":"2025-12-02T12:52:46.058939+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-dg6","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:46.059628+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-dtj","content_hash":"07d92fef76f41b5ae6cd6c095534aeaf7399ab94bc329c568aa6ad3a9f922b72","title":"feat: Feishu document change tracking system","description":"","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-02T11:45:09.561927+08:00","updated_at":"2025-12-02T11:45:09.561927+08:00","source_repo":"."}
{"id":"feishu_assistant-dzf","content_hash":"77740faa9ece0d5041b84624d68186d878ce6a4f7cfa98c04e860d6775e35f86","title":"Integration test with real Feishu doc","description":"\n- Create test doc in Feishu\n- Fetch metadata\n- Verify all fields present and correct\n- Test with different doc types (doc, sheet, bitable)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:55.526022+08:00","updated_at":"2025-12-02T11:46:55.526022+08:00","source_repo":"."}
{"id":"feishu_assistant-ebu","content_hash":"f948d4101331df1e5fcded052a7cf49f49d5b62056363fcdb3cc2f9973c6cd78","title":"feat: Feishu document change tracking system (Epic)","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-02T11:45:36.121389+08:00","updated_at":"2025-12-02T11:45:36.121389+08:00","source_repo":"."}
{"id":"feishu_assistant-eeb","content_hash":"7fca47a85fb3000df96b26fb220f052f9d142e8dd26612b56214b2a38b0c9dd9","title":"Buttons fail with sequence number error - separate sequence counters conflict","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-20T19:23:43.043973+08:00","updated_at":"2025-11-20T19:25:35.678357+08:00","closed_at":"2025-11-20T19:25:35.678357+08:00","source_repo":"."}
{"id":"feishu_assistant-f15","content_hash":"7e30bb698a622e8e8a0d39456a83d5a62d927c67e2b848bd70e6be2b9db31efa","title":"Establish code style conventions for implementation docs","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-20T17:28:28.811304+08:00","updated_at":"2025-11-20T17:28:28.811304+08:00","source_repo":"."}
{"id":"feishu_assistant-f4i","content_hash":"9df95ed4341e14816c4549ff24a9e73ef974c018bdc72b2e420abdd4b96ee823","title":"TODO 2: Implement change detection algorithm with debouncing","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:21.065793+08:00","updated_at":"2025-12-02T14:50:13.504909+08:00","closed_at":"2025-12-02T14:50:13.504909+08:00","source_repo":"."}
{"id":"feishu_assistant-fbc","content_hash":"d84c5aa90c3575749ae99d037456696dbbdc5d42c68ba14f55e3a78fbc4f398b","title":"Write unit tests for all migrated agents","description":"# Unit Tests for Migrated Agents\n\n## Context\nEach agent needs unit tests to verify:\n- Initialization works\n- Responds to queries\n- Tool calls work\n- Error handling correct\n\n## What Needs to Be Done\n1. Update test/agents/manager-agent.test.ts:\n   - Test initialization with Mastra\n   - Test query routing to specialists\n   - Test fallback on error\n   \n2. Update test/agents/okr-reviewer-agent.test.ts:\n   - Test OKR analysis queries\n   - Test tool execution\n   - Test error handling\n   \n3. Similar tests for other agents:\n   - alignment-agent.test.ts\n   - pnl-agent.test.ts\n   - dpa-pm-agent.test.ts\n\n4. Test suite configuration:\n   - Mock models if needed\n   - Mock tools\n   - Use test utilities\n   \n5. Achieve \u003e80% code coverage\n\n## Files Involved\n- test/agents/*.test.ts (update all)\n- lib/agents/*.ts (may add test utilities)\n\n## Success Criteria\n- ‚úÖ All agents have unit tests\n- ‚úÖ Tests pass\n- ‚úÖ Coverage \u003e80%\n- ‚úÖ Error cases covered\n\n## Blocked By\n- All agent migrations (Phase 2)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:45.700593+08:00","updated_at":"2025-12-02T12:52:45.700593+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-fbc","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.701615+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-fbh","content_hash":"d23e365d128d86412a85ced2e74f4c818891ed8986146494d4020237ec34aced","title":"Phase 2: Testing, documentation, and reliability hardening","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:45:21.51934+08:00","updated_at":"2025-12-02T11:45:21.51934+08:00","source_repo":"."}
{"id":"feishu_assistant-fgd","content_hash":"41983df38f91c804aedb70321ed14c2df51f4e523b27b0a34c447b3fe232198f","title":"feat: Document tracking tests (unit, integration, load, E2E)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:07:38.14769+08:00","updated_at":"2025-12-02T12:07:38.14769+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-fgd","depends_on_id":"feishu_assistant-c0y","type":"parent-child","created_at":"2025-12-02T12:07:38.149182+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-fs5","content_hash":"d727cd9747aaed57945b79aa5b5765e2cafd5b932d5fcf5d0284b955ae781ad7","title":"Update documentation and code comments","description":"# Update Documentation\n\n## Context\nEnsure docs reflect new Mastra architecture.\n\n## What Needs to Be Done\n1. Update docs/architecture/agent-framework.md:\n   - Current: ai-sdk-tools dual agents\n   - Target: Mastra single agent with model array\n   - Explain why change (simplicity, maintainability)\n   \n2. Update docs/setup/:\n   - Remove ai-sdk-tools references\n   - Add Mastra setup instructions\n   - Langfuse integration guide\n   - PostgreSQL memory backend guide\n   \n3. Update code comments:\n   - Manager Agent\n   - Each specialist agent\n   - Memory integration\n   - Observability config\n   \n4. Update AGENTS.md code conventions (if needed)\n\n## Files Involved\n- docs/architecture/agent-framework.md (update)\n- docs/setup/mastra-observability.md (new or update)\n- docs/setup/memory-backend.md (update)\n- AGENTS.md (update if needed)\n- All agent files (update comments)\n\n## Success Criteria\n- ‚úÖ Docs reflect Mastra architecture\n- ‚úÖ Setup instructions clear\n- ‚úÖ Code comments updated\n- ‚úÖ No references to removed code\n\n## Blocked By\n- Deprecate custom devtools\n- Remove ai-sdk-tools\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:46.295659+08:00","updated_at":"2025-12-02T12:52:46.295659+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-fs5","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:46.296448+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-fsc","content_hash":"fc70b21d00359eebf2d008f82ca06782235d7d597faa4f3f9e7bd5705ef6642f","title":"Phase 5c: Memory Persistence Validation","description":"","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.257622+08:00","updated_at":"2025-11-27T17:04:10.162467+08:00","source_repo":"."}
{"id":"feishu_assistant-fvn","content_hash":"74d02b97f4a97cc569380b865a1b61c59d3349db6e326eabde10a612bda7580e","title":"Setup PinoLogger for structured logging in Mastra","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:49:15.950748+08:00","updated_at":"2025-12-02T12:49:15.950748+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-fvn","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:49:15.951986+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-go7","content_hash":"a6386d24b5d95d7e3b6c7fd6ea47dfa1079b131f154576d89bf67c13fd5fadc5","title":"Phase 5a: Setup Test Feishu Environment","description":"Setup dedicated Feishu test group with proper webhooks and monitoring. Server running in Subscription Mode with Devtools enabled. Test group: oc_cd4b98905e12ec0cb68adc529440e623. Devtools API endpoints ready.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:00.985619+08:00","updated_at":"2025-11-27T15:46:23.65265+08:00","closed_at":"2025-11-27T15:46:23.65265+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-go7","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:00.98759+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-grr","content_hash":"191ce5c7c2828b6393183cbcf210c9865ba9e250bd8d9a7af956b3a13bf9cc23","title":"Investigate alternative button UI approaches - blocked by Feishu API constraint","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-21T13:17:00.242215+08:00","updated_at":"2025-11-21T13:17:00.242215+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-grr","depends_on_id":"feishu_assistant-ujn","type":"discovered-from","created_at":"2025-11-21T13:17:00.243207+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-gvb","content_hash":"9ddbf63db55eed960a56d6f2221fad85f1de9dc11a2d9f02a72bebae55222e12","title":"[9/10] Implement comprehensive test suite (unit, integration, load, e2e)","description":"\nBuild comprehensive test coverage ensuring reliability and correctness.\n\nüéØ GOAL: \u003e85% code coverage, zero crashes, scalable to 100+ docs\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n\nUNIT TESTS (30+):\n- getDocMetadata: all success/error paths\n- hasDocChanged: all edge cases\n- formatDocChange: output formatting\n- Command parsing: all command types\n- Error handling: rate limits, invalid responses\n\nINTEGRATION TESTS (15+):\n- Real Feishu test docs\n- Full polling lifecycle\n- Notification sending\n- Persistence/restore\n- Multi-doc tracking\n\nLOAD TESTS (5+):\n- 100 concurrent tracked docs\n- 1000 rapid changes\n- API rate limiting behavior\n- Memory usage trends\n- Memory leak detection\n\nE2E TESTS (10+):\n- User watch ‚Üí detect ‚Üí notify flow\n- Multi-group tracking\n- Restart/recovery\n- Error recovery scenarios\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- Mock Feishu responses for unit tests\n- Use test Feishu org for integration tests\n- Load tests: use k6 or autocannon\n- E2E: might be manual initially, automate later\n- Coverage tools: c8 for coverage reporting\n\nTEST INFRASTRUCTURE:\n- Jest/Vitest for unit/integration\n- Mock Feishu client\n- Test database (separate Supabase project)\n- Load testing tool (k6)\n- CI/CD integration (GitHub Actions)\n\n‚úÖ SUCCESS CRITERIA:\n1. \u003e85% line coverage\n2. \u003e90% function coverage  \n3. All error paths tested\n4. Load test: 100 docs, \u003c10% failure rate\n5. No memory leaks (heap snapshots)\n6. CI passing on every commit\n7. Test docs clear and maintainable\n\n‚úÖ TESTING CHECKLIST:\n- [ ] Unit tests for all core functions\n- [ ] Integration tests with real Feishu\n- [ ] Load test suite (100+ docs)\n- [ ] E2E test workflows\n- [ ] Error scenario testing\n- [ ] Performance benchmarks\n- [ ] Chaos testing (API fails, network issues)\n- [ ] Concurrent test suite (thread safety)\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 9 section\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:54.42461+08:00","updated_at":"2025-12-02T11:46:54.42461+08:00","source_repo":"."}
{"id":"feishu_assistant-h38","content_hash":"18d7889254ae7fbf641020fe05b7af1e049b09d00fde758722a2a6545dfd8018","title":"Fix: Resolve mentioned user identity for correct memory scoping","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T17:26:24.364461+08:00","updated_at":"2025-11-27T17:26:31.53065+08:00","closed_at":"2025-11-27T17:26:31.53065+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-h38","depends_on_id":"feishu_assistant-lra","type":"discovered-from","created_at":"2025-11-27T17:26:24.365963+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-h62","content_hash":"7b4c73dc1e231025c6c73f64657d2dd1f716c7ca4ef1eef3a9298626b9843fec","title":"Phase 3: Advanced features and optimizations","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-02T11:45:21.845544+08:00","updated_at":"2025-12-02T11:45:21.845544+08:00","source_repo":"."}
{"id":"feishu_assistant-hlv","content_hash":"8b9bf00f7617022064766aa7efa7b408882d17d54f037bb03748a23149d89c3f","title":"Consolidate shared tools and verify compatibility","description":"# Consolidate Tools - Verify Compatibility\n\n## Context\nTools are already compatible with both frameworks (use universal tool() from 'ai' package).\n\n## What Needs to Be Done\n1. Review all tools:\n   - lib/tools/search-web-tool.ts\n   - lib/tools/okr-review-tool.ts\n   - lib/agents/okr-visualization-tool.ts\n   \n2. Verify tool signatures:\n   - All use tool() from 'ai' package ‚úì\n   - No ai-sdk-tools specific code\n   \n3. Test tool execution with Mastra agents\n   \n4. No code changes needed, just verification\n\n## Files Involved\n- lib/tools/*.ts (review only)\n- test/agents/*.test.ts (verify tool execution)\n\n## Success Criteria\n- ‚úÖ All tools execute correctly with Mastra agents\n- ‚úÖ Tool definitions verified compatible\n- ‚úÖ Tool outputs match expected format\n- ‚úÖ Tests passing\n\n## Notes\nThis is mostly verification since tools already use universal 'ai' package signatures.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:44.892187+08:00","updated_at":"2025-12-02T12:52:44.892187+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-hlv","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.893107+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-i51","content_hash":"4b1764ec0b180a0dd5fcb7db64227ee29fd075b43a587f4b4d4a59346b998bd2","title":"Phase 5h: Phase 5 Documentation \u0026 Release Notes","description":"Document findings, create release notes, prepare for Phase 6","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.995837+08:00","updated_at":"2025-11-27T15:36:01.995837+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-i51","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.997192+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-i5g","content_hash":"7a7ee912b20fdd684520254670d858ad102e5e5cf5bd7741fe54a7de9abdb2f6","title":"[5/10] Implement document content snapshots and semantic diff engine","description":"\nStore document snapshots and compute semantic diffs.\n\nüéØ GOAL: Answer \"WHAT changed?\" not just \"WHO and WHEN?\"\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n- On each change detected, optionally download full content\n- Store compressed snapshot in Supabase\n- Compute semantic diff between snapshots\n- Generate human-readable change summary\n\nDATABASE SCHEMA:\nTable: document_snapshots\n  - id UUID PK\n  - doc_token STRING\n  - revision INTEGER\n  - content_hash STRING (SHA256)\n  - content_size INTEGER\n  - modified_by STRING\n  - modified_at TIMESTAMP\n  - stored_at TIMESTAMP\n  - content_compressed BYTEA (gzipped JSON)\n  - metadata JSONB (indices for searching)\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- Storage overhead: docs can be 10MB+, might blow up\n- Compression crucial: gzip typically 5-10x reduction\n- Diff computation expensive: only do on demand\n- Not all doc types suitable (images, binary less useful)\n- Consider tiered retention: keep recent snapshots, archive old\n\nDIFF ALGORITHM:\nOption 1: Simple text diff (fast)\n  - Line-by-line comparison\n  - Shows insertions/deletions/modifications\n  - ~100ms for typical doc\n\nOption 2: Semantic diff (slow, better quality)\n  - Parse document structure\n  - Diff at semantic level (blocks, paragraphs)\n  - Better for humans to read\n  - ~500ms for typical doc\n\nHybrid: Show simple for quick display, semantic on demand\n\n‚úÖ EDGE CASES:\n1. Very large docs (10MB+) ‚Üí don't snapshot automatically\n2. Binary content (sheets, images) ‚Üí different handling\n3. Rapid changes ‚Üí don't snapshot every change\n4. Storage quota ‚Üí archive old snapshots\n\n‚úÖ SUCCESS CRITERIA:\n1. Snapshots \u003c1GB for 1000 changes\n2. Compression ratio \u003e5x\n3. Diff computation \u003c500ms\n4. Supports 90% of doc types\n5. Old snapshots auto-archival works\n6. Queries for historical analysis fast\n\n‚úÖ TESTING:\n1. Test with various document sizes\n2. Test compression ratios\n3. Test diff accuracy\n4. Benchmark storage/retrieval\n5. Test archival policies\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 5 section\n- FEISHU_DOC_TRACKING_INVESTIGATION.md Section 8 (limitations)\n","notes":"\n‚úÖ Implemented:\n- lib/doc-snapshots.ts: Snapshot service with compression, size limits, retention\n- lib/semantic-diff.ts: Line-level and semantic diff computation with 3 output formats\n- lib/doc-snapshot-integration.ts: Integration layer wiring snapshots into polling\n- Feishu SDK integration: downloadDocContent, downloadSheetContent, downloadBitableContent\n- test/doc-snapshots.test.ts: 40+ unit tests for snapshots and diffs\n- test/doc-snapshot-integration.test.ts: Integration tests for workflows\n\n‚úÖ Key features:\n- Gzip compression with ratio tracking (target \u003e5x)\n- Size limit enforcement (default 10MB)\n- Auto-archival of old snapshots (default 90 days)\n- Block-level and line-level diffs\n- Human-readable change summaries\n- Support for doc, sheet, bitable types\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:46:54.755806+08:00","updated_at":"2025-12-02T18:37:01.142203+08:00","source_repo":".","labels":["implementation-complete"]}
{"id":"feishu_assistant-i9s","content_hash":"45da30475886467fedaf7ccb485f64c83382c9ea703a43375a8e5696f27e0b55","title":"feat: DocumentTracking specialist agent (Agent Architecture Phase 2)","description":"","notes":"Document tracking test suite: all 49 tests passing (19 unit + 13 poller + 17 integration). Build successful 5.7mb bundle. Timestamp formatting issues fixed. Ready for production validation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-02T12:28:48.697448+08:00","updated_at":"2025-12-02T16:20:22.735181+08:00","closed_at":"2025-12-02T16:20:22.735188+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-i9s","depends_on_id":"feishu_assistant-c0y","type":"parent-child","created_at":"2025-12-02T12:28:48.699304+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-ibe","content_hash":"2f0e5937777981c76a63259970b78a806ff8a1660084b677622e1c26cc3b2d98","title":"Render follow-up options as interactive buttons on Feishu cards","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-20T17:52:34.153059+08:00","updated_at":"2025-11-20T18:01:45.996325+08:00","closed_at":"2025-11-20T18:01:45.996325+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-ibe","depends_on_id":"feishu_assistant-xx9","type":"discovered-from","created_at":"2025-11-20T17:52:34.153636+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-inh","content_hash":"ae39ba380c9c23f19beb2deadf6f3ba7364df90ec5ae30a36cb549068596f573","title":"Verify PostgreSQL schema for Mastra memory backend","description":"# Verify PostgreSQL Schema for Mastra Memory Backend\n\n## Context\nMastra memory system requires a PostgreSQL backend with specific schema. This task verifies the schema is correctly set up and can handle conversation history, tool call logs, and user context.\n\n## What Needs to Be Done\n\n1. Review existing schema in lib/memory-mastra.ts\n   - Check table definitions for threads, messages, runs\n   - Verify columns match Mastra's expectations\n   - Look for indexes on frequently queried columns (user_id, thread_id, timestamp)\n\n2. Run migrations if needed\n   - Check Supabase migrations directory\n   - Apply any pending migrations\n   - Verify schema version\n\n3. Test schema functionality\n   - Create test user context\n   - Insert sample conversation\n   - Query by thread_id, user_id, timestamp\n   - Verify RLS policies\n\n4. Document schema\n   - Add comments to schema.sql\n   - Document index strategy\n   - Record any migration notes\n\n## Technical Details\n\n### Tables Expected\n- **threads** - Conversation contexts (user_id, thread_id, metadata)\n- **messages** - Message history (thread_id, role, content, metadata)\n- **runs** - Agent execution history (thread_id, agent_name, input, output, status)\n\n### Key Requirements\n- Row-level security (RLS) for multi-user isolation\n- Proper indexing for fast queries (user_id + thread_id is common pattern)\n- Timestamp columns for proper ordering\n- JSONB fields for flexible metadata storage\n\n## Success Criteria\n- ‚úÖ Schema exists and is accessible\n- ‚úÖ All required tables have proper columns\n- ‚úÖ Indexes exist for performance queries\n- ‚úÖ RLS policies correctly isolate users\n- ‚úÖ Test data can be inserted and queried\n\n## Files Involved\n- lib/memory-mastra.ts - Review schema\n- supabase/migrations/ - Apply migrations\n- docs/implementation/mastra-memory-schema.md - Document findings\n\n## Blockers\nNone - this is foundational\n\n## Notes\nSchema verification happens BEFORE running actual agents, so issues here will prevent agent migration.\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:49:16.329209+08:00","updated_at":"2025-12-02T12:49:32.838263+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-inh","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:49:16.331117+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-jre","content_hash":"a1b05a8d5ed68d63d722d33f72d0faf91c0ac51c0ebae0b68496035f3b47676a","title":"Phase 4f: Verify Devtools Web UI Functionality","description":"Verify devtools web interface displays and filters agent events correctly.\n\nKEY DELIVERABLE: Working devtools UI for real-time monitoring of agent behavior.\n\nREASONING: UI is primary tool for developers to understand agent behavior. Must verify it displays correct data, updates in real-time, and filtering works.\n\nIMPLEMENTATION PLAN:\n1. Start server (bun run dev or npm start)\n2. Visit http://localhost:3000/devtools\n3. Verify page loads and displays events\n4. Test filtering by agent name\n5. Test search functionality\n6. Verify token usage displayed\n7. Check real-time updates while agents run\n\nACCEPTANCE CRITERIA:\n‚úì Devtools UI loads without errors\n‚úì Event list displays agent activities\n‚úì Can filter events by agent name\n‚úì Can search for keywords in event data\n‚úì Token usage shown per event\n‚úì Response times displayed in ms\n‚úì Real-time updates while agents run\n‚úì UI responsive (no lag when scrolling)\n\nMANUAL TESTING:\n1. Generate events by calling agents\n2. Verify event appears in UI within seconds\n3. Filter by Manager ‚Üí only Manager events shown\n4. Filter by OKR ‚Üí only OKR events shown\n5. Search 'error' ‚Üí only error events shown\n6. Search 'timeout' ‚Üí only events with 'timeout' data shown\n\nBROWSER CHECKS:\n- Works in Chrome/Safari/Firefox\n- Events sorted by time (newest first)\n- Event details expandable\n- Filters persist on page reload (if desired)\n- Mobile responsiveness\n\nCONTEXT:\n- Devtools UI code in server.ts (HTTP handlers for /devtools)\n- Frontend likely uses web components or simple HTML\n- Real-time updates via polling or WebSocket\n- Token usage in event.usage field (if Mastra provides)\n\nFUTURE WORK:\n- Real-time WebSocket updates instead of polling\n- Graph visualization of agent routing paths\n- Timeline view of agent execution\n- Export functionality for event logs\n- Custom alert rules (e.g., alert on error \u003e 5 per minute)","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-27T15:15:20.76318+08:00","updated_at":"2025-11-27T15:15:20.76318+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-jre","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:15:20.764122+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-jut","content_hash":"e2cebfec29789001d118db2269d1b243c292710e72d4165233b2c91db8305e63","title":"Server startup time is too slow, blocking development","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-28T15:39:12.370406+08:00","updated_at":"2025-11-28T15:52:13.974236+08:00","closed_at":"2025-11-28T15:52:13.974236+08:00","source_repo":"."}
{"id":"feishu_assistant-jwo","content_hash":"895addccddf36e99a8bef94f886bb02471b6ed5f5567b7024a4b913de659d068","title":"Phase 5h: Phase 5 Documentation \u0026 Release Notes","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.868237+08:00","updated_at":"2025-11-27T15:35:51.868237+08:00","source_repo":"."}
{"id":"feishu_assistant-k5h","content_hash":"1fb7a34022d3330303d1cb5d66b9a60e4a7f98d0b457ea358bbcffcc311417a3","title":"Fix TypeScript deep type recursion workarounds","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-20T17:42:40.184363+08:00","updated_at":"2025-11-20T17:42:40.184363+08:00","source_repo":"."}
{"id":"feishu_assistant-k7r","content_hash":"bb26301c5fc4593191fc1d50e4cafe29f0792cfdde8acc0d5c8e639139d16604","title":"feat: Feishu document change tracking system","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-02T11:45:20.68138+08:00","updated_at":"2025-12-02T11:45:20.68138+08:00","source_repo":"."}
{"id":"feishu_assistant-kdp","content_hash":"d9297bc1f2d3843a71615b1750079c36372219c0c3ef34793d0d70066c61213b","title":"Test Mastra memory connection pooling and transactions","description":"# Test Mastra Memory Connection Pooling\n\n## Context\nConnection pooling is critical for production. We need to verify:\n- Pool creates connections correctly\n- Idle connections are recycled\n- Max pool size enforced\n- Transaction isolation works\n- Concurrent requests handled properly\n\n## What Needs to Be Done\n1. Create test script: scripts/test-memory-pooling.ts\n   - Open 50 concurrent connections\n   - Verify max pool size is respected\n   - Check connection wait times\n   - Verify no leaks\n\n2. Test transaction behavior:\n   - Start transaction, insert, rollback\n   - Verify rollback works\n   - Test concurrent transactions\n   - Check isolation levels\n\n3. Test RLS under load:\n   - Concurrent requests from different users\n   - Verify no data leaks\n   - Check RLS policy enforcement\n\n4. Measure performance:\n   - Query latency (target \u003c50ms)\n   - Connection reuse ratio\n   - Memory usage under load\n\n## Technical Details\n- Connection pooling library: pg (Node.js PostgreSQL client)\n- Max pool size: 20 (tunable based on load tests)\n- Connection timeout: 30s\n- Idle timeout: 30s\n- Transaction isolation: READ_COMMITTED (default)\n\n## Files Involved\n- scripts/test-memory-pooling.ts (new)\n- lib/memory-mastra.ts (may need tuning)\n\n## Success Criteria\n- ‚úÖ Pool limits enforced\n- ‚úÖ Concurrent operations complete without errors\n- ‚úÖ Query latency \u003c50ms\n- ‚úÖ RLS isolation maintained\n- ‚úÖ Memory doesn't leak\n- ‚úÖ Performance metrics documented\n\n## Related Tasks\n- All agent migration tasks depend on this\n\n## Notes\nRun this before agents start to catch pooling issues early.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:44.194926+08:00","updated_at":"2025-12-02T12:52:44.194926+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-kdp","depends_on_id":"feishu_assistant-4ir","type":"blocks","created_at":"2025-12-02T12:52:44.195833+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-kjl","content_hash":"8571eac95bf2e4f13607e2dc77e7a6bf057dac5f27e78b4fe2d8b60d7a107a3c","title":"Alternative UI for follow-up suggestions - text-based menu or markdown links","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-21T12:05:54.322503+08:00","updated_at":"2025-11-21T12:29:35.998215+08:00","closed_at":"2025-11-21T12:29:35.998215+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-kjl","depends_on_id":"feishu_assistant-61u","type":"discovered-from","created_at":"2025-11-21T12:05:54.323503+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-kug","content_hash":"e688b4e0b36a94f7b875e46dad4156b963b8e1a8dac490d15d0d7d383b9e3c34","title":"Buttons feature not fully working - multiple implementation issues","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-20T19:27:28.804228+08:00","updated_at":"2025-11-21T14:39:18.331564+08:00","closed_at":"2025-11-21T14:39:18.331564+08:00","source_repo":"."}
{"id":"feishu_assistant-l2t","content_hash":"8ae118de009c41642eddbf80e43d57222453def81a8c346065502dfa34cbc2ab","title":"[10/10] Add metrics, monitoring, and performance optimization","description":"\nImplement comprehensive observability and performance optimization.\n\nüéØ GOAL: Production-ready monitoring and debugging capabilities\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n\nMETRICS TO EXPOSE:\n- document_polling_documents_tracked (gauge)\n- document_polling_last_duration_ms (gauge)\n- document_polling_success_rate (gauge, 0-1)\n- document_changes_detected_total (counter)\n- document_notifications_sent_total (counter)\n- document_notifications_failed_total (counter)\n- feishu_api_calls_total (counter)\n- feishu_api_latency_ms (histogram)\n- poller_queue_depth (gauge)\n\nHEALTH CHECK ENDPOINT:\nGET /health/document-polling\n‚Üí {\n  \"status\": \"healthy|degraded|unhealthy\",\n  \"lastPollTime\": 1234567890,\n  \"documentsTracked\": 42,\n  \"errorCount\": 2,\n  \"nextPollIn\": 15000,\n  \"metrics\": { ... }\n}\n\nALERTING RULES:\n1. Success rate \u003c 90% for 10min ‚Üí warn\n2. \u003e5 consecutive API failures ‚Üí warn\n3. Queue depth \u003e 100 ‚Üí warn\n4. Memory usage \u003e 500MB ‚Üí warn\n5. Poller hasn't run in 60s ‚Üí error\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- Metrics should not impact performance\n- Async metric collection\n- Prometheus format for compatibility\n- Alert thresholds configurable\n- Historical metrics retention (Prometheus setup)\n\nPERFORMANCE OPTIMIZATION:\n1. Batch API requests (up to 200 docs/call)\n2. Cache recently fetched metadata (5min TTL)\n3. Async change notifications (don't block polling)\n4. Connection pooling for API calls\n5. Memory pooling for temporary objects\n\nOBSERVABILITY IMPLEMENTATION:\n- Structured logging (JSON format)\n- Trace IDs for request correlation\n- Performance profiling hooks\n- Error tracking integration (optional)\n- Dashboard visualization (Grafana/Kibana)\n\n‚úÖ SUCCESS CRITERIA:\n1. Health check responds \u003c100ms\n2. Metrics accurate and up-to-date\n3. CPU \u003c5% idle, \u003c15% at full load\n4. Memory \u003c200MB at 100 docs\n5. No memory leaks (24h baseline)\n6. All alerts working\n7. Dashboards viewable\n\n‚úÖ TESTING:\n1. Unit tests for all metrics\n2. Integration test metric accuracy\n3. Load test metrics under stress\n4. Baseline performance benchmarks\n5. Memory profiling (v8 snapshots)\n\nOBSERVABILITY STACK:\n- Logging: structured JSON to stdout\n- Metrics: Prometheus format endpoint\n- Tracing: optional (future)\n- Dashboards: optional (future)\n- Alerting: PagerDuty hooks (future)\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 10 section\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:46:54.978122+08:00","updated_at":"2025-12-02T11:46:54.978122+08:00","source_repo":"."}
{"id":"feishu_assistant-l39","content_hash":"0126545640881a5d256b549403806f1af6aeb444d9dcb0ded8e87c64ad75405f","title":"Integrate chart streaming into OKR reviewer agent","description":"Wire up chart generation tool and OKR streaming functions into the OKR reviewer agent.\n\n## What's Ready\n- chartGenerationTool (Mermaid \u0026 Vega-Lite builders)\n- streamComprehensiveOKRAnalysis() (queries real okr_metrics.db)\n- All code tested with real OKR data (47 companies, 10Êúà period)\n\n## Work to Do\n1. Add chartGenerationTool to OKR agent's tools array\n2. Import streamComprehensiveOKRAnalysis in agent\n3. Update agent system prompt to mention chart capability\n4. Test end-to-end with Feishu query\n5. Verify charts stream and render\n\n## Implementation Details\n- File: lib/agents/okr-reviewer-agent.ts\n- Add tool import and to tools array\n- Update instructions to use charts for visualization requests\n- Test with: 'OKRÂàÜÊûêÂíåÂõæË°®' or 'Show OKR charts'\n\n## Expected Outcome\n- User queries 'OKRÂàÜÊûê' ‚Üí Gets response with streaming bar chart + pie chart + insights\n- Charts show real data from okr_metrics.db\n- Markdown streams progressively with typewriter effect\n\n## Blockers\n- None (all dependencies ready)\n\n## Notes\n- Related: streamOKRCompanyAnalysis(), streamOKRMetricTypeAnalysis() also available\n- See: lib/okr-chart-streaming.ts for implementation\n- See: NEXT_SESSION_CHARTS_INTEGRATION.md for context","status":"open","priority":1,"issue_type":"feature","created_at":"2025-11-21T16:49:26.785071+08:00","updated_at":"2025-11-21T16:49:37.438813+08:00","source_repo":"."}
{"id":"feishu_assistant-lb1","content_hash":"6e69fbbbe1f2326be007a580ff902c9ee03b3ec79ddca07430044e5ce7f18fd1","title":"Write E2E tests for full Feishu workflow","description":"# E2E Tests for Full Feishu Workflow\n\n## Context\nE2E tests verify the complete flow: Feishu mention ‚Üí server ‚Üí agents ‚Üí response ‚Üí Feishu card.\n\n## What Needs to Be Done\n1. Review existing E2E tests in test/integration/end-to-end.test.ts\n2. Update to use Mastra agents\n3. Test full flow:\n   - Receive mention webhook\n   - Extract user/chat context\n   - Load memory\n   - Call manager agent\n   - Get response\n   - Verify sent to Feishu\n4. Test variants:\n   - Group mention\n   - Direct message\n   - Follow-up (button click)\n\n## Files Involved\n- test/integration/end-to-end.test.ts (update)\n\n## Success Criteria\n- ‚úÖ E2E tests passing\n- ‚úÖ All workflow variants work\n- ‚úÖ No regressions\n\n## Blocked By\n- All agent migrations\n- Memory transition complete\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:45.943041+08:00","updated_at":"2025-12-02T12:52:45.943041+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-lb1","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.944251+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-lom","content_hash":"ddf8ea8ae9a85a46219a02085ce01b575fb773abf177ecc6849b80e16219fc0a","title":"Test bot mention detection after fix","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-28T15:28:25.178349+08:00","updated_at":"2025-11-28T15:52:30.308559+08:00","closed_at":"2025-11-28T15:52:30.308559+08:00","source_repo":"."}
{"id":"feishu_assistant-lra","content_hash":"5ceac734521a2f1373d0797a7bb1450902e696238eaed9456fee5f78e7231d2f","title":"Phase 5c: Memory Persistence Validation","description":"Verify memory works correctly with real data, RLS isolation, multi-turn context","notes":"Phase 5c-2 testing infrastructure complete. All documentation, monitoring scripts, and execution guides ready. Critical memory fix deployed (mentioned user ID extraction). Devtools cleared and waiting for test messages. See QUICK_START_TESTING.txt for one-page reference or PHASE_5C_EXECUTION_GUIDE.md for detailed steps.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.289629+08:00","updated_at":"2025-11-28T14:32:24.107688+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-lra","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.292287+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-lri","content_hash":"bfa5eaa8a415d4d434c518c6146c269959a96591301e7df6b42bc125586a0c09","title":"Phase 4a: Verify Devtools Integration in Specialist Agents","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:14:09.788081+08:00","updated_at":"2025-11-27T15:14:09.788081+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-lri","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:14:09.789379+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-lu3","content_hash":"dc09e5770a849e193e9fc539f5b189cf4f84568a40fbdbd3c2b208b2c00b9115","title":"Debug and fix OKR chart generation in Feishu","description":"","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-11-21T17:25:12.579221+08:00","updated_at":"2025-11-21T17:25:17.930203+08:00","source_repo":"."}
{"id":"feishu_assistant-m3r","content_hash":"51af4af928613ca1a4f7255fa8d7fa40e07dea931e2975ec6c6d1316db1af05b","title":"Phase 4g: Document Phase 4 Completion \u0026 Approach","description":"Comprehensive documentation of Phase 4 implementation for knowledge transfer and future reference.\n\nKEY DELIVERABLE: Complete Phase 4 documentation explaining what was done, why, and how it works.\n\nREASONING: Documentation is critical for:\n1. Knowledge transfer (future developers understand design decisions)\n2. Onboarding (new team members understand the system)\n3. Maintenance (future changes understand existing patterns)\n4. Historical record (why were these choices made?)\n\nIMPLEMENTATION PLAN:\n1. Create history/PHASE_4_COMPLETION.md with:\n   - Executive summary (what was done)\n   - Memory integration approach (design, tradeoffs, decisions)\n   - Devtools integration approach (what's tracked, how)\n   - Test results and coverage\n   - Known limitations and future work\n2. Update AGENTS.md with:\n   - Memory integration patterns (how to use memory in agents)\n   - Devtools instrumentation guidelines\n   - Best practices for agent development\n3. Create history/PHASE_5_HANDOFF.md for next session\n4. Document all commits with meaningful messages\n\nACCEPTANCE CRITERIA:\n‚úì history/PHASE_4_COMPLETION.md created with \u003e1000 words\n‚úì Includes decision rationale (why we chose Supabase memory over Mastra native)\n‚úì Includes architecture diagrams or ASCII art\n‚úì Lists all agents modified and changes made\n‚úì Documents test results (60 pass, 7 expected timeouts)\n‚úì Documents known issues (DrizzleProvider schema, etc)\n‚úì AGENTS.md updated with memory/devtools patterns\n‚úì Phase 5 handoff document created\n‚úì All commits have descriptive messages\n\nDOCUMENT STRUCTURE:\n\n**PHASE_4_COMPLETION.md**:\n1. Executive Summary\n   - What: Memory + Devtools integration into Mastra agents\n   - Why: Multi-turn context, observability for production\n   - Result: All 5 agents now persistent + instrumented\n2. Design Decisions\n   - Memory: Chose Supabase over Mastra native (why?)\n   - Devtools: Chose existing tracker over new system (why?)\n   - Tradeoffs documented\n3. Implementation Details\n   - Memory integration (how it works)\n   - Devtools tracking (what's tracked, when)\n   - RLS/user scoping approach\n   - Error handling strategy\n4. Test Results\n   - 60/67 tests passing (7 expected timeouts)\n   - Test coverage by agent\n   - Known test environment issues\n5. Known Limitations\n   - DrizzleProvider schema validation\n   - Token usage availability (verify with Mastra)\n   - Real Feishu testing needed\n6. Future Work\n   - Phase 5: Real Feishu testing\n   - Phase 6: Production deployment\n   - Future improvements (semantic search, cost alerts, etc)\n\nCONTEXT:\n- Phase 4 completed: Memory + Devtools integration\n- Used existing infrastructure (Supabase, devtools-integration.ts)\n- Chose minimal changes approach (low risk)\n- All agents now production-ready for Phase 5 testing\n- Graceful degradation when dependencies unavailable","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:15:41.642377+08:00","updated_at":"2025-11-27T15:33:31.162196+08:00","closed_at":"2025-11-27T15:33:31.162196+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-m3r","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:15:41.643905+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-m6l","content_hash":"41ee46679b5c8da392d41169ac1e6e03f7cd8c65720e0483036464001fafdde0","title":"Handle rate limiting for free LLM models (kwaipilot 429 errors)","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-20T17:42:45.434957+08:00","updated_at":"2025-11-25T17:48:43.356241+08:00","closed_at":"2025-11-25T17:48:43.356241+08:00","source_repo":"."}
{"id":"feishu_assistant-mj1","content_hash":"b20fb0660b7d7cb5ae6d94237966aa49a8d2579f3430c58bbaef4fc95a53cb7e","title":"Phase 4a: Verify Devtools Integration in Specialist Agents","description":"Ensure all specialist agents (OKR, Alignment, P\u0026L, DPA-PM) properly track events via devtools.\n\nKEY DELIVERABLE: All 5 agents (Manager, OKR, Alignment, P\u0026L, DPA-PM) properly integrated with devtoolsTracker for complete observability.\n\nREASONING: Devtools is critical for debugging, monitoring, and optimizing agent performance in production. Without proper tracking, we can't see what agents are doing or identify bottlenecks.\n\nIMPLEMENTATION PLAN:\n1. Verify all specialist agents import devtoolsTracker\n2. Check trackAgentCall() called at start of each agent execution  \n3. Check trackResponse() called with duration after completion\n4. Verify token usage extracted from Mastra responses\n5. Ensure trackError() called on failures\n\nACCEPTANCE CRITERIA:\n‚úì All 5 agents call trackAgentCall() when invoked\n‚úì Agent responses tracked with duration and metadata\n‚úì Errors properly caught and tracked\n‚úì Manual routing decisions logged to devtools\n‚úì Token usage populated in response events\n\nCONTEXT:\n- Manager agent already fully instrumented (manager-agent-mastra.ts:21,200,240,259...)\n- Specialist agents need verification\n- Manager routes to specialists via manual pattern matching\n- Each specialist should track independently for performance visibility\n- Devtools enables post-mortem analysis of slow/errored responses\n\nFUTURE WORK:\n- Integrate Mastra's native observability if available\n- Add span context for distributed tracing\n- Consider OpenTelemetry integration for cloud platforms","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:14:58.958967+08:00","updated_at":"2025-11-27T15:24:09.425652+08:00","closed_at":"2025-11-27T15:24:09.425652+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-mj1","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:14:58.962226+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-ml7","content_hash":"4d8771bb5daa30a12532b929700f871fd4c15711a0136d870dc21131e3b197d6","title":"task: Agent routing in manager-agent.ts (recognize doc tracking commands)","description":"","notes":"Document tracking test suite: all 49 tests passing (19 unit + 13 poller + 17 integration). Build successful 5.7mb bundle. Timestamp formatting issues fixed. Ready for production validation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-02T12:28:55.117825+08:00","updated_at":"2025-12-02T16:20:22.765211+08:00","closed_at":"2025-12-02T16:20:22.765218+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-ml7","depends_on_id":"feishu_assistant-i9s","type":"parent-child","created_at":"2025-12-02T12:28:55.121776+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-mlg","content_hash":"087d48459734d269e9b759f16293667556440793ee5d5772bfcca716d45b2a3d","title":"feat: Document tracking rules engine \u0026 actions (Phase 2)","description":"","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-02T12:07:43.84264+08:00","updated_at":"2025-12-02T12:07:43.84264+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-mlg","depends_on_id":"feishu_assistant-c0y","type":"parent-child","created_at":"2025-12-02T12:07:43.844146+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-mt0","content_hash":"5e75655e33836939cc86a879ed0da0a4533b0f6cec45db499a68184f45161c99","title":"TODO 1: Implement getDocMetadata() function with retry logic","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:20.956913+08:00","updated_at":"2025-12-02T14:49:59.396755+08:00","closed_at":"2025-12-02T14:49:59.396755+08:00","source_repo":"."}
{"id":"feishu_assistant-mvl","content_hash":"bb909ff0b5db2989be71f132e38710b54f58257f15368d6656041975541bdb08","title":"Remove duplicate follow-up text from streaming response card","description":"Follow-up suggestions were being appended to the streaming response card in text form AND displayed as separate buttons. This created duplicate information. Solution: Keep card text clean (response only), display follow-ups only as interactive buttons in separate message.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-28T11:44:19.598098+08:00","updated_at":"2025-11-28T11:44:24.040455+08:00","closed_at":"2025-11-28T11:44:24.040455+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-mvl","depends_on_id":"feishu_assistant-lra","type":"discovered-from","created_at":"2025-11-28T11:44:19.599865+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-o07","content_hash":"fbcffa7829a6b99c8e1a0370314703255c8df43f082cd1c501398021e61fed25","title":"Buttons not rendering in conversation - finalizeCardWithFollowups not being called","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-20T19:15:21.972151+08:00","updated_at":"2025-11-25T17:48:43.615706+08:00","closed_at":"2025-11-25T17:48:43.615706+08:00","source_repo":"."}
{"id":"feishu_assistant-o85","content_hash":"b64408003558e07354f32b2757342d88726a76fce002fe4eed79239a01d13e9e","title":"[6/10] Build rules engine for conditional actions and reactions","description":"\nEnable conditional actions triggered by document changes.\n\nüéØ GOAL: React to changes with custom actions (not just notifications)\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n\nRULES INTERFACE:\ninterface ChangeRule {\n  id: string;\n  docToken: string;\n  name: string;\n  condition: {\n    type: 'any' | 'modified_by_user' | 'content_match' | 'time_range';\n    value?: string | string[];\n  };\n  action: {\n    type: 'notify' | 'create_task' | 'webhook' | 'aggregate';\n    target?: string;\n    template?: string;\n  };\n  enabled: boolean;\n}\n\nEXAMPLE RULES:\n1. \"Notify @john only on Monday-Friday\"\n2. \"Create task when status doc reaches 100%\"\n3. \"Aggregate changes every hour, send summary\"\n4. \"Call webhook on specific content patterns\"\n5. \"Notify Slack when critical section changes\"\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- Rules can be complex, need validation\n- Prevent infinite loops (action triggers rule triggers action)\n- Rules should be user-configurable eventually\n- Current phase: hard-coded rules + admin setup\n\nRULES ENGINE ARCHITECTURE:\n‚îå‚îÄ Change Detected ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ WHO, WHEN, WHAT            ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n         ‚Üì\n‚îå‚îÄ Rules Evaluator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ For each enabled rule:      ‚îÇ\n‚îÇ 1. Evaluate condition       ‚îÇ\n‚îÇ 2. If match, execute action ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n         ‚Üì\n‚îå‚îÄ Action Executor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ - Notify (existing)        ‚îÇ\n‚îÇ - Create task (new)        ‚îÇ\n‚îÇ - Webhook (new)            ‚îÇ\n‚îÇ - Aggregate (new)          ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n‚úÖ SUCCESS CRITERIA:\n1. Rule evaluation \u003c100ms\n2. 100+ rules evaluatable\n3. Rules never block polling\n4. Action failures don't affect other actions\n5. Rules logged for debugging\n6. History of rule executions audited\n\n‚úÖ TESTING:\n1. Test all condition types\n2. Test all action types\n3. Test rule evaluation performance\n4. Test error handling (action fails)\n5. Test rule conflicts\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 6 section\n","notes":"\n‚úÖ Implemented:\n- lib/rules-engine.ts: Core rules engine with condition/action evaluation\n  * 5 condition types: any, modified_by_user, content_match, time_range, change_type\n  * 4 action types: notify, create_task, webhook, aggregate\n  * CRUD operations for rule management\n  * Rule validation and execution tracking\n  \n- lib/rules-integration.ts: Integration with polling workflow\n  * Async rule evaluation queue (non-blocking)\n  * Rule statistics and queue management\n  * Example rules for common patterns\n  * Graceful error handling\n  \n- test/rules-engine.test.ts: 35+ unit tests\n  * Condition evaluation tests\n  * Action execution tests\n  * Performance tests (\u003c100ms target)\n  * Error handling and validation\n  \n- test/rules-integration.test.ts: 25+ integration tests\n  * Queue management and draining\n  * Async/sync evaluation modes\n  * Multi-change workflows\n  * Load testing (100+ rapid evaluations)\n\n‚úÖ Key features:\n- Non-blocking async evaluation (doesn't stall polling)\n- Multiple condition types (user, time, change type, patterns)\n- Multiple action targets (notify, webhook, task, aggregation)\n- Rule validation on create/update\n- Execution tracking and statistics\n- \u003c100ms rule evaluation performance (target met)\n- Support for 100+ rules per document\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T11:46:54.867745+08:00","updated_at":"2025-12-02T18:41:47.187354+08:00","source_repo":".","labels":["implementation-complete"]}
{"id":"feishu_assistant-pjj","content_hash":"ec61f1ba333b94e1f1d28aaaa66e0839482c7490ab09650fb126b59cec49dc02","title":"Phase 4c: Track Token Usage \u0026 Cost Estimation","description":"Track token consumption across agents and estimate inference costs for billing/monitoring.\n\nKEY DELIVERABLE: Complete token accounting system visible in devtools for cost analysis and optimization.\n\nREASONING: Token costs are primary operational expense. Must track usage by agent, model, and time period to understand spending, identify inefficiencies, and optimize prompts.\n\nIMPLEMENTATION PLAN:\n1. Extract token usage from Mastra response objects\n2. Calculate cost based on model pricing tables\n3. Include in devtools events (usage field)\n4. Aggregate statistics by agent/model\n5. Expose via devtools API\n\nACCEPTANCE CRITERIA:\n‚úì Input/output tokens captured in devtools events\n‚úì Cost estimated per response using current model pricing\n‚úì Statistics aggregatable by agent name and model\n‚úì Visible in devtools API: GET /devtools/api/stats\n‚úì Shown in devtools UI with costs per event\n\nCONTEXT:\n- Models in use: primary (Claude/OpenAI), fallback (other provider)\n- Different models have different token prices\n- Need model registry with pricing info\n- Mastra responses should contain usage info (need to verify)\n- Dev existing tokenCounter utilities in lib/shared/model-fallback.ts\n\nTECHNICAL NOTES:\n- Cost calculation: (input_tokens √ó input_price + output_tokens √ó output_price)\n- Pricing varies by model: Claude 3.5 vs GPT-4 vs fallback models\n- Track which model actually executed (primary vs fallback)\n- Accumulate costs per request for billing accuracy\n\nFUTURE WORK:\n- Budget tracking and alerts (warn if exceeding monthly budget)\n- Per-user cost tracking for multi-tenant scenarios\n- Model recommendation engine based on performance vs cost\n- Integration with billing system","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-27T15:14:59.32817+08:00","updated_at":"2025-11-27T15:14:59.32817+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-pjj","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:14:59.330256+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-pth","content_hash":"14e1f49c8f9a34d64e3180ada5a84171700397f5c09de825d51f0fc6769b8903","title":"[7/10] Implement bot commands (watch, check, unwatch, watched)","description":"\nBuild user-facing commands for document tracking management.\n\nüéØ GOAL: Users can easily watch/check/unwatch documents\n\nüèóÔ∏è DESIGN REQUIREMENTS:\nCommand: @bot watch \u003cdoc_url_or_token\u003e\n  - Extract doc token from URL or direct token\n  - Validate doc exists and accessible\n  - Start tracking\n  - Confirm with card showing doc info\n  - Store in database\n\nCommand: @bot check \u003cdoc_url_or_token\u003e\n  - Fetch current metadata\n  - Show: title, last editor, last edit time\n  - Show: recent 5 changes (timestamps)\n  - Show: who edited in last 24h\n\nCommand: @bot unwatch \u003cdoc_url_or_token\u003e\n  - Stop tracking\n  - Confirm with message\n  - Keep audit trail\n\nCommand: @bot watched [group:\u003cname\u003e]\n  - List all tracked docs in this group\n  - Show count, last edit times\n  - Provide quick unwatch buttons\n\nCommand: @bot tracking:status\n  - Show poller health (docs tracked, last poll, error count)\n  - Useful for operators/debugging\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- URL parsing: extract token from Feishu share URLs\n- Error handling: what if doc doesn't exist? Removed? No access?\n- Context inference: \"Watch this\" ‚Üí infer doc from previous messages\n- Natural language: \"Monitor spreadsheet\" ‚Üí search doc by title\n- Permissions: user can only watch if they have access\n\nCARD RESPONSE FORMAT:\nTitle: üìÑ Document Status\nFields:\n  - Document: [title]\n  - Status: Being tracked / Not tracked\n  - Last modified: [user] at [time]\n  - Recent editors: @john, @jane, @bob\n  - Last changes: (timestamps)\n\nActions:\n  - [View in Feishu] [Stop Tracking] [Change Rules]\n\n‚úÖ SUCCESS CRITERIA:\n1. Command parsing works for all formats\n2. URL extraction handles all Feishu link types\n3. Error messages helpful (why failed?)\n4. Commands responsive (\u003c500ms p95)\n5. Cards well formatted and informative\n6. Natural language variants work\n\n‚úÖ TESTING:\n1. Parse various URL formats\n2. Test error cases (invalid doc, no access)\n3. Test with special characters in title\n4. Test with very long doc titles\n5. E2E: watch ‚Üí check ‚Üí unwatch\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_INVESTIGATION.md Section 6 (usage examples)\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 7 section\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:54.208127+08:00","updated_at":"2025-12-02T11:46:54.208127+08:00","source_repo":"."}
{"id":"feishu_assistant-q9c","content_hash":"b35a0b1270ba4bee8c2e01bae9fc1384609509bc54aa202e6b018fabd447193c","title":"Phase 5: Real Feishu Integration Testing - Complete","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-11-27T15:35:43.95091+08:00","updated_at":"2025-11-27T15:35:43.95091+08:00","source_repo":"."}
{"id":"feishu_assistant-qkq","content_hash":"2062763a3d08c5bc20a41810c4782fb4626345cc9a5ff77bc6398f16c3959b70","title":"TODO 4: Add Supabase persistence for tracked documents","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:21.299512+08:00","updated_at":"2025-12-02T14:50:13.714147+08:00","closed_at":"2025-12-02T14:50:13.714147+08:00","source_repo":"."}
{"id":"feishu_assistant-rfs","content_hash":"8c12b83113b5b8b9e10dc55ff1ba14bbd05760a4efa1d7f7684c542779e26b26","title":"Phase 5f: Phased Rollout Execution","description":"Execute 3-phase rollout: single user ‚Üí small group ‚Üí all users","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.712432+08:00","updated_at":"2025-11-27T15:36:01.712432+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-rfs","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.714082+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-rlf","content_hash":"51646ab5b9dfd0199fc3d804e484caa52a19923375dbc665ebba5fc53012bddd","title":"TODO 3: Build DocumentPollingService with lifecycle management","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:21.181242+08:00","updated_at":"2025-12-02T14:50:13.609247+08:00","closed_at":"2025-12-02T14:50:13.609247+08:00","source_repo":"."}
{"id":"feishu_assistant-rxz","content_hash":"41cc69eba60373ef59098925fadef4d98a379c8f8ef19530b0318a295b310c1b","title":"TODO 8: Write comprehensive documentation (user, dev, operator guides)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:45:21.627189+08:00","updated_at":"2025-12-02T11:45:21.627189+08:00","source_repo":"."}
{"id":"feishu_assistant-s5p","content_hash":"21916435d8d372a3ee3c8e19214e69a846f62c74a60cd7eff64a8e8c96d7fba2","title":"Investigate alternative button UI approaches - blocked by Feishu API constraint","description":"","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-11-21T13:17:07.909345+08:00","updated_at":"2025-11-21T14:09:17.884629+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-s5p","depends_on_id":"feishu_assistant-ujn","type":"discovered-from","created_at":"2025-11-21T13:17:07.909943+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-sbi","content_hash":"60f57d89729dac9f29640e3ee7fd055d81ef1ad9f160cb8005b6c6d4824cf19c","title":"Phase 5d: Devtools Monitoring Verification","description":"Ensure all events captured, filtering works, statistics accurate","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.428687+08:00","updated_at":"2025-11-27T15:36:01.428687+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-sbi","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.430638+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-su1","content_hash":"f725b1416e1ad883de5993f7af4a51db828edcea6b735c9dd414790bf2acde94","title":"Handle button selection and feed back to agent as new query","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-20T17:52:41.652186+08:00","updated_at":"2025-11-20T18:18:01.330625+08:00","closed_at":"2025-11-20T18:18:01.330625+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-su1","depends_on_id":"feishu_assistant-ibe","type":"discovered-from","created_at":"2025-11-20T17:52:41.652959+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-t7h","content_hash":"fe60fdd3e198d62cff834633211672af4a390cf689e3ef34879d0d037797e179","title":"Phase 4b: Validate Memory Persistence Across Turns","description":"Validate conversation history is persisted and retrieved correctly across multi-turn agent calls.\n\nKEY DELIVERABLE: Proven memory system that maintains context across agent interactions and respects user/chat isolation.\n\nREASONING: Multi-turn context is essential for natural conversations. Users expect agents to remember previous messages and use them to inform responses. Without memory, each message is stateless and context is lost.\n\nIMPLEMENTATION PLAN:\n1. Test multi-turn conversation (Q1‚ÜíA1, Q2‚ÜíA2 with context awareness)\n2. Verify RLS/user scoping prevents cross-user contamination\n3. Test graceful fallback when memory backend unavailable\n4. Verify InMemoryProvider used in test environments\n5. Ensure memory failures don't crash agents\n\nACCEPTANCE CRITERIA:\n‚úì Multi-turn conversation maintains context (agent acknowledges prior messages)\n‚úì Different users have completely isolated memory (User A can't see User B's chats)\n‚úì Tests pass with both Supabase backend and InMemory fallback\n‚úì Memory operations fail gracefully with warnings\n‚úì Agents continue operating if memory unavailable\n\nCONTEXT:\n- Memory integration added to manager agent (manager-agent-mastra.ts:166-182)\n- Conversation scoped by: feishu:${chatId}:${rootId}\n- User scoped by: user:${userId}\n- Graceful fallback to InMemoryProvider when SUPABASE_DATABASE_URL not set\n- Known issue: DrizzleProvider schema validation fails in tests (but doesn't crash)\n\nKNOWN ISSUES \u0026 MITIGATIONS:\n- DrizzleProvider expects schema tables that don't exist in test DB\n  ‚Üí Gracefully catches errors and continues (try-catch wrapper)\n  ‚Üí Only affects test environment; production Supabase works fine\n- Memory save operations are async and wrapped in try-catch\n  ‚Üí If save fails, agent continues; warning logged\n  ‚Üí Follows 'fail-open' principle (availability \u003e consistency for this use case)\n\nTECHNICAL NOTES:\n- Uses @ai-sdk-tools/memory DrizzleProvider with Supabase backend\n- Message save uses ConversationMessage format: {chatId, userId, role, content, timestamp}\n- Conversation history limited to 5 messages (configurable in loadConversationHistory)\n- Working memory stored as JSON string (for future learned facts storage)\n\nFUTURE WORK:\n- Add semantic similarity search for message retrieval\n- Implement working memory updates (track user preferences, learned facts)\n- Add conversation summarization for long threads\n- Test with actual Feishu multi-turn conversations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T15:14:59.085716+08:00","updated_at":"2025-11-27T15:25:13.841418+08:00","closed_at":"2025-11-27T15:25:13.841418+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-t7h","depends_on_id":"feishu_assistant-0c7","type":"parent-child","created_at":"2025-11-27T15:14:59.087032+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-ujn","content_hash":"fd18c1ee1a42f676730ad83d37f8b54d93df8b862968633c9015ba78eb2e6775","title":"Implement real suggestion button UIs in assistant chat for direct interaction","description":"","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-21T12:51:43.762052+08:00","updated_at":"2025-11-21T13:15:03.078967+08:00","closed_at":"2025-11-21T13:15:03.078967+08:00","source_repo":"."}
{"id":"feishu_assistant-ujr","content_hash":"09cbc4f69defc21ac59965472f22bbd9dd27bb0ae5afeaa8f9d5871d3551775d","title":"[1/10] Implement getDocMetadata() with Feishu API integration","description":"\nImplement reliable wrapper for Feishu's legacy docs-api/meta endpoint.\n\nüéØ GOAL: Get document metadata (title, owner, last_modified_user, last_modified_time)\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n- Handle raw HTTP request to POST /open-apis/suite/docs-api/meta\n- Extract and validate response (latest_modify_user, latest_modify_time)\n- Implement error handling (404, 403, transient errors)\n- Retry logic with exponential backoff (100ms, 500ms, 2000ms)\n- Proper timestamp conversion (Unix seconds ‚Üí JS milliseconds)\n- Type safety: map Feishu response to DocMetadata interface\n- Logging: debug, warn, error levels with context\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- This is the FOUNDATION - all change detection depends on it\n- Feishu's legacy API might behave differently than modern APIs\n- At scale (100+ docs), need to batch requests (200 docs per call)\n- Type assertions needed: resp?.success?.() vs resp.code === 0\n\n‚úÖ SUCCESS CRITERIA:\n1. Unit tests: Handle all error cases gracefully\n2. Integration test: Fetch metadata from real test doc\n3. Handles deleted docs without crashing\n4. Handles permission changes without crashing\n5. Performance: \u003c500ms per call (p95)\n6. Works with doc, sheet, bitable, docx types\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_INVESTIGATION.md Section 1\n- lib/feishu-utils.ts (existing SDK setup)\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:53.767952+08:00","updated_at":"2025-12-02T11:46:53.767952+08:00","source_repo":"."}
{"id":"feishu_assistant-ur5","content_hash":"a2e0b37af0f0129099c59dccc68c283fb64b04e78f3ff8189b0bac61d432fba5","title":"Phase 5d: Devtools Monitoring Verification","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:35:51.386068+08:00","updated_at":"2025-11-27T15:35:51.386068+08:00","source_repo":"."}
{"id":"feishu_assistant-v8r","content_hash":"01b9630c02127d0a1cab5e779c4b0e1a9ee42a0162929d2859fdeed5709de908","title":"Update .gitignore to exclude /history/ directory","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-20T17:28:19.527161+08:00","updated_at":"2025-11-20T17:28:19.527161+08:00","source_repo":"."}
{"id":"feishu_assistant-vmj","content_hash":"3087b9f2e5bae8320df56e0cf1606939ca95acb3280bec16331e358c4afba481","title":"Configure Langfuse AI Tracing exporter","description":"# Configure Langfuse AI Tracing Exporter\n\n## Context\nLangfuse is the recommended observability platform for Mastra. It provides:\n- LLM-specific analytics (token usage, latency, costs)\n- Agent execution traces (decision paths, tool calls)\n- Real-time debugging in development\n- Production monitoring with alerts\n\n## What Needs to Be Done\n1. Create Langfuse account and get API keys\n2. Add environment variables to .env:\n   - LANGFUSE_PUBLIC_KEY\n   - LANGFUSE_SECRET_KEY\n   - LANGFUSE_BASE_URL (optional, defaults to cloud)\n3. Create observability config in lib/observability-config.ts:\n   - Real-time mode for development\n   - Batch mode for production\n   - Appropriate sampling rates\n4. Register Langfuse exporter with Mastra:\n   - Import LangfuseExporter from @mastra/core\n   - Add to observability config\n   - Test exporter connectivity\n5. Add Langfuse dashboard link to documentation\n\n## Technical Details\n- Real-time: NODE_ENV=development ‚Üí flush every trace immediately\n- Batch: production ‚Üí buffer traces, flush every 5-10 seconds\n- Sampling: 100% in dev, 1% in prod (reduce costs)\n- Token counting enabled by default\n\n## Files Involved\n- lib/observability-config.ts (new)\n- server.ts (import observability config)\n- .env.example (add Langfuse keys)\n- docs/setup/langfuse-observability.md (new)\n\n## Success Criteria\n- ‚úÖ Langfuse API keys work\n- ‚úÖ Traces appear in Langfuse dashboard\n- ‚úÖ Token usage tracked correctly\n- ‚úÖ Real-time tracing works in dev\n- ‚úÖ Batch mode works in prod\n\n## External Links\n- https://mastra.ai/docs/observability/ai-tracing/exporters/langfuse\n- https://langfuse.com/docs\n\n## Related Tasks\n- Add Mastra observability to server.ts\n- Migrate Manager Agent\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:43.893732+08:00","updated_at":"2025-12-02T12:52:43.893732+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-vmj","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:43.895048+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-vt9","content_hash":"24be1604ffbfdba3d6565b93a21bed9ce221ff453937e659ee7679ed669bbbd3","title":"[2/10] Implement change detection algorithm with debouncing","description":"\nBuild logic to detect when document has changed.\n\nüéØ GOAL: Accurately detect changes using only metadata (no content diff yet)\n\nüèóÔ∏è DESIGN REQUIREMENTS:\n- Interface TrackedDoc: { docToken, lastKnownUser, lastKnownTime, chatId }\n- Function hasDocChanged(current, previous): boolean\n- Change is detected if: user changed OR time changed\n- Debouncing: ignore changes within 5 seconds (same edit session)\n- Never send duplicate notifications for same change\n- Track attribution: log WHO made the change\n\n‚ö†Ô∏è  CONSIDERATIONS:\n- Can't detect WHAT changed, only WHO and WHEN\n- Multiple edits in same second might be missed (polling interval issue)\n- What if user edits, then reverts? (Still notify - acceptable)\n- Simultaneous multi-user editing only shows last editor\n- Clock skew: server time != client time (use server time only)\n\n‚úÖ EDGE CASES TO HANDLE:\n1. First time tracking (no previous state) ‚Üí always notify\n2. Rapid successive edits (\u003c5s apart) ‚Üí debounce to one notification\n3. Same user editing multiple times ‚Üí notify on each change\n4. Different users editing alternately ‚Üí notify on each change\n5. Document deleted ‚Üí stop tracking gracefully\n6. Permissions revoked ‚Üí stop tracking gracefully\n\n‚úÖ SUCCESS CRITERIA:\n1. Unit tests for all edge cases\n2. Debouncing works correctly (no spam)\n3. No false positives (notifications only on real changes)\n4. No false negatives (catches all changes)\n5. Handles null/undefined states gracefully\n\nüìö REFERENCES:\n- FEISHU_DOC_TRACKING_ELABORATION.md TODO 2 section\n- FEISHU_DOC_TRACKING_INVESTIGATION.md Section 3\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:53.875873+08:00","updated_at":"2025-12-02T11:46:53.875873+08:00","source_repo":"."}
{"id":"feishu_assistant-vu1","content_hash":"0346f8690a79b4504e373b1829600765e28ae0a43f2491188bd16cc3b2f4bd23","title":"task: Cross-agent queries (e.g. 'watch OKR doc AND show numbers')","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-02T12:29:04.480076+08:00","updated_at":"2025-12-02T12:29:04.480076+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-vu1","depends_on_id":"feishu_assistant-i9s","type":"parent-child","created_at":"2025-12-02T12:29:04.481107+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-wm1","content_hash":"e2a6cdc441a0378742143b7c4ac132a8f2b3a4d9f7b085ef8956ae1c4ab2d532","title":"Migrate OKR Reviewer Agent to Mastra framework","description":"# Migrate OKR Reviewer Agent to Mastra\n\n## Context\nOKR Reviewer analyzes OKR data using DuckDB and generates reviews. This is a specialist agent that Manager routes to.\n\n## Current Implementation\n- ai-sdk-tools/agents framework\n- Dual agent pattern (primary + fallback)\n- Custom devtools tracking\n- Tool: okr-review-tool with DuckDB queries\n- Caching with @ai-sdk-tools/cache\n\n## Target Implementation\n- Mastra Agent with model array\n- Native observability\n- Tool unchanged (already compatible)\n- Caching via Mastra (if available) or keep existing\n\n## What Needs to Be Done\n1. Create lib/agents/okr-reviewer-agent.ts (from -mastra.ts)\n   - Replace ai-sdk-tools Agent with Mastra Agent\n   - Update model array\n   - Keep all tool definitions\n   \n2. Verify tool compatibility:\n   - okr-review-tool still works\n   - caching configuration\n   \n3. Update memory integration:\n   - Use getMemoryThread() from memory-mastra.ts\n   - Verify conversation context passed correctly\n   \n4. Update imports in manager-agent.ts\n5. Delete okr-reviewer-agent-mastra.ts\n\n## Files Involved\n- lib/agents/okr-reviewer-agent.ts (replace)\n- lib/agents/okr-reviewer-agent-mastra.ts (delete)\n- lib/tools/okr-review-tool.ts (no changes needed)\n- test/agents/okr-reviewer-agent.test.ts (update)\n\n## Success Criteria\n- ‚úÖ Agent initializes\n- ‚úÖ Handles OKR analysis queries\n- ‚úÖ Tool execution works\n- ‚úÖ Caching still functional\n- ‚úÖ Memory integration works\n- ‚úÖ Tests passing\n\n## Blocked By\n- Migrate Manager Agent\n\n## Related Tasks\n- Migrate Alignment Agent\n- Migrate P\u0026L Agent\n- Migrate DPA-PM Agent\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:44.424766+08:00","updated_at":"2025-12-02T12:52:44.424766+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-wm1","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:44.426023+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-xx9","content_hash":"73d0cb8c1d703310aee94e6f5a0eef63d0d6def8d1a3785fac174bfc6acfc8b2","title":"Generate follow-up questions/recommendations for agent responses","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-20T17:52:24.167953+08:00","updated_at":"2025-11-20T17:58:56.119663+08:00","closed_at":"2025-11-20T17:58:56.119663+08:00","source_repo":"."}
{"id":"feishu_assistant-y0t","content_hash":"4dbd60135b58307548072e8fc32a01a45503170f0badd20c05992c60cbdde906","title":"Research Feishu docs-api/meta endpoint and response schema","description":"\nUnderstand the exact request/response format for docs-api/meta.\n- Test with real Feishu docs\n- Document all response fields\n- Identify error codes and meanings\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:55.085554+08:00","updated_at":"2025-12-02T11:46:55.085554+08:00","source_repo":"."}
{"id":"feishu_assistant-yce","content_hash":"7c2bb95b19fd841b13119e82027fb3ab396cbe6ab3c7344898fb7e027f2dd8ad","title":"Cannot extract mentioned user ID in @bot messages","description":"## Problem\n\nUser mentions (@user_name) in @bot messages are not being extracted/recognized by the bot.\n\nExample:\n```\n@bot @some_user What are the key principles of OKR setting?\n```\n\nExpected: Bot extracts user ID for 'some_user' and uses it for memory context\nActual: User ID not being extracted or used\n\n## Impact\n\n- Memory scoping depends on extracted user ID\n- Without correct user ID, memory is scoped to wrong user/context\n- Follow-up questions lose context if user ID is wrong\n\n## Investigation Needed\n\n1. Check if mentions array includes both @bot and @user_name\n2. Verify extraction logic handles mixed mentions correctly\n3. Check if extraction is case-sensitive\n4. Test with different mention formats (@username, @first.last, etc.)\n\n## Logs to Check\n\nLook for:\n- 'Extracted mentioned user ID:' - should show user's open_id\n- 'Using user ID for memory context:' - should use extracted ID\n- Memory initialization logs - should show correct user scoping\n\n## Possible Causes\n\n1. Mentions array structure different than expected\n2. First mention extraction assumes user, not bot\n3. User mention format not recognized by Feishu\n4. Extraction only happens if bot mention is first?","notes":"Fix deployed (commit f6f1a52): Now properly skips bot mention and extracts actual user mention from mentions array. Logic changed to find first non-bot mention instead of taking first mention blindly.\n\nTesting needed: Send @bot @user_name message and verify extraction in logs shows correct user ID.","status":"in_progress","priority":1,"issue_type":"bug","created_at":"2025-11-28T14:51:38.913296+08:00","updated_at":"2025-11-28T14:53:55.577016+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-yce","depends_on_id":"feishu_assistant-lra","type":"discovered-from","created_at":"2025-11-28T14:51:38.915423+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-yg8","content_hash":"6303acba2cf7afc33a30d5742c0416d8ee5535880a795526357eac1a4277e255","title":"Deprecate custom devtools-integration.ts","description":"# Deprecate Custom Devtools\n\n## Context\nCustom devtools-integration.ts was a workaround before Mastra AI Tracing. Now we have better observability.\n\n## What Needs to Be Done\n1. Verify all functionality covered by Langfuse:\n   - Agent calls ‚úì\n   - Tool calls ‚úì\n   - Error tracking ‚úì\n   - Performance metrics ‚úì\n   \n2. Remove devtools tracking calls from code:\n   - lib/agents/*.ts (remove devtoolsTracker calls)\n   - lib/tools/*.ts (remove tracking)\n   \n3. Remove devtools endpoints from server.ts:\n   - /devtools/api/* endpoints\n   - devtools HTML page serving\n   \n4. Remove devtools files:\n   - lib/devtools-integration.ts\n   - lib/devtools-page.html\n   \n5. Update documentation (remove devtools references)\n\n## Impact\n- Cleaner codebase (~300 lines removed)\n- Single source of truth (Langfuse) instead of custom tracking\n- Better observability in production\n\n## Files Involved\n- lib/devtools-integration.ts (delete)\n- lib/devtools-page.html (delete)\n- lib/agents/*.ts (remove tracker calls)\n- server.ts (remove endpoints)\n\n## Success Criteria\n- ‚úÖ All tracking removed\n- ‚úÖ No devtools references\n- ‚úÖ Langfuse provides same insights\n- ‚úÖ Tests still passing\n\n## Blocked By\n- Setup Langfuse tracing for agents\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-02T12:52:45.58982+08:00","updated_at":"2025-12-02T12:52:45.58982+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-yg8","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.590672+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-yt7","content_hash":"fc09da922de1ee3bae8ed09c5d828cab81a6be91a9ae284fec422f3469f7d3cf","title":"Phase 5g: Monitoring \u0026 Alerting Setup","description":"Configure devtools dashboard, set up alert thresholds, test procedures","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-27T15:36:01.854989+08:00","updated_at":"2025-11-27T15:36:01.854989+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-yt7","depends_on_id":"feishu_assistant-q9c","type":"parent-child","created_at":"2025-11-27T15:36:01.857447+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-yu0","content_hash":"253e84d02a5d2049f412b4ab0afa8b330b86e7c30f01a8488143104941d91915","title":"Write unit tests for getDocMetadata()","description":"\nTest all cases:\n- Successful metadata fetch\n- 404 (doc deleted)\n- 403 (permission denied)\n- 429 (rate limit)\n- Network timeout\n- Invalid response format\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T11:46:55.416137+08:00","updated_at":"2025-12-02T11:46:55.416137+08:00","source_repo":"."}
{"id":"feishu_assistant-zba","content_hash":"00aec7b89c159ca8a1c8dfdc55fda9bbfbaa69c814b4e6f01168dd846456a7cf","title":"Text repeats in response cards - streaming update sending accumulated text instead of delta","description":"","status":"open","priority":1,"issue_type":"bug","created_at":"2025-11-20T19:21:23.657755+08:00","updated_at":"2025-11-20T19:21:23.657755+08:00","source_repo":"."}
{"id":"feishu_assistant-zh9","content_hash":"92eda9ff17515ffa7c7a2eee49c644906dff7e9ea2b72efed83200fa9fd85d32","title":"Write integration tests for multi-turn conversations","description":"# Integration Tests for Multi-Turn Conversations\n\n## Context\nIntegration tests verify agents work together, memory persists, and conversations flow.\n\n## What Needs to Be Done\n1. Create test/integration/mastra-multiturn.test.ts:\n   - Manager routes to specialist\n   - Specialist responds\n   - Response is saved to memory\n   - Follow-up query retrieves context\n   - Test with Mastra memory backend\n   \n2. Test scenarios:\n   - Simple question ‚Üí manager ‚Üí web search\n   - OKR question ‚Üí manager ‚Üí OKR specialist\n   - Follow-up question ‚Üí context preserved\n   \n3. Verify memory behavior:\n   - Conversation loaded from Mastra memory\n   - Messages saved after response\n   - Timestamps recorded\n   \n4. Test error handling:\n   - Invalid query\n   - Specialist unavailable\n   - Memory connection error\n\n## Files Involved\n- test/integration/mastra-multiturn.test.ts (new)\n- test/helpers/test-fixtures.ts (may update)\n\n## Success Criteria\n- ‚úÖ Multi-turn conversations work\n- ‚úÖ Memory persists correctly\n- ‚úÖ Error handling graceful\n- ‚úÖ Tests passing\n\n## Blocked By\n- All agent migrations\n- Memory transition complete\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-02T12:52:45.821298+08:00","updated_at":"2025-12-02T12:52:45.821298+08:00","source_repo":".","dependencies":[{"issue_id":"feishu_assistant-zh9","depends_on_id":"feishu_assistant-1mv","type":"parent-child","created_at":"2025-12-02T12:52:45.822074+08:00","created_by":"daemon"}]}
{"id":"feishu_assistant-zsb","content_hash":"e5fdcb6e71b0c909013960c8307879376a8cbdae68912bd23562ae88807b7eb9","title":"Migrate memory system to Mastra's 3-layer architecture with PostgreSQL backend","description":"## Completed Implementation\n\n‚úÖ **Mastra 3-Layer Memory Architecture with PostgreSQL Backend**\n\n### What Was Built\n\nReplaced @ai-sdk-tools/memory with Mastra's native Memory system for structured, persistent context management.\n\n### Three Memory Layers\n\n1. **Conversation History** - Recent 20 messages for short-term context\n2. **Working Memory** - Persistent user facts, preferences, goals (Markdown format)\n3. **Semantic Recall** - Vector-based RAG retrieval of relevant past messages\n\n### Storage Backend\n\n- **Database**: Supabase PostgreSQL (local via Orbstack: )\n- **Package**: @mastra/pg (Mastra's PostgreSQL adapter)\n- **RLS Enforcement**: Database-level Row Level Security prevents cross-user data access\n\n### Files Created/Modified\n\n**Created:**\n- `lib/memory-mastra.ts` (157 lines) - Mastra Memory initialization and helpers\n- `lib/memory-mastra.test.ts` (44 lines) - Test suite for memory functions\n\n**Modified:**\n- `lib/agents/manager-agent-mastra.ts` - Integrated Mastra Memory initialization and per-request setup\n- `server.ts` - Added Mastra Memory initialization on startup\n\n### Key Features\n\n‚úÖ User-scoped memory isolation (Feishu user ID)\n‚úÖ Thread-scoped conversation isolation (chat ID + root ID)\n‚úÖ Database-enforced RLS (PostgreSQL native)\n‚úÖ Automatic table management via PostgreSQL storage adapter\n‚úÖ Semantic search across all conversations\n‚úÖ Backward compatible with existing memory-integration.ts\n\n### Testing\n\n- ‚úÖ All memory initialization tests passing (4/4)\n- ‚úÖ Manager agent integration tests passing\n- ‚úÖ Production transpilation successful (5.7MB bundle)\n- ‚úÖ Server startup confirms: 'Mastra Memory initialized'\n\n### Example: RLS in Action\n\nUser A and User B both chat with bot:\n- Alice: `SELECT * FROM agent_messages` ‚Üí sees only Alice's messages (RLS blocks others)\n- Bob: `SELECT * FROM agent_messages` ‚Üí sees only Bob's messages (RLS blocks others)\n- Database enforces this automatically - no app-level filtering needed\n\n### Why PostgreSQL over libsql?\n\n- libsql has NO RLS support (SQLite limitation)\n- PostgreSQL RLS is enforced at database layer (impossible to bypass)\n- Application-level filtering in libsql is error-prone\n- Production-grade security model\n\n### Commit\n\n`32f8865` - feat: implement Mastra 3-layer memory with PostgreSQL backend\n\n### Architecture Diagram\n\n```\nFeishu Bot\n    ‚Üì\nmanager-agent-mastra.ts (receives user ID, chat ID, root ID)\n    ‚Üì\ncreateMastraMemory(feishuUserId) creates Memory instance\n    ‚Üì\nMemory instance with 3 layers:\n  - Conversation History (recent 20 messages)\n  - Working Memory (persistent facts)\n  - Semantic Recall (vector search)\n    ‚Üì\nPostgresStore (@mastra/pg)\n    ‚Üì\nSupabase PostgreSQL (localhost:54322)\n    ‚Üì\nRLS Policies (enforced per user_id)\n```\n\n### Next Steps\n\nOptional future enhancements:\n- Implement semantic recall vector embeddings\n- Add working memory updating logic\n- Monitor memory usage per user/conversation\n- Cache memory retrieval for performance\n","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-28T12:28:10.555896+08:00","updated_at":"2025-11-28T12:59:47.030114+08:00","closed_at":"2025-11-28T12:36:14.683294+08:00","source_repo":"."}
